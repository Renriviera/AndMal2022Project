{
  "hash": "f85bf0a90222b12d4c18ea2c1bef1488",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Family Prediction Models\"\nformat: html\n---\n\nThis document trains three category-specific random forest models to predict malware family within each category (Adware, Riskware, and Trojan).\n\n## Load Libraries and Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ranger)\nlibrary(dplyr)\nlibrary(caret)\nlibrary(parallel)\nlibrary(lime)\nlibrary(fastshap)\nlibrary(ggplot2)\nlibrary(stringr)\n\n# Configuration\nnum_threads <- 8L\nnum_trees <- 500L\ntrain_test_split <- 0.8\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load preprocessed data (from preprocessing.qmd)\nandmal_after <- readRDS(\"data/processed/andmal_after.rds\")\n\ncat(sprintf(\"Loaded dataset: %d rows, %d columns\\n\", nrow(andmal_after), ncol(andmal_after)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLoaded dataset: 25059 rows, 185 columns\n```\n\n\n:::\n:::\n\n\n## Feature Selection\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Metadata columns to exclude from features (keep only Category)\nmetadata_cols <- c(\"Family\", \"Category_file\", \"reboot_state\", \"path\", \"file\", \"Hash\")\n\n# Get all column names\nall_cols <- names(andmal_after)\n\n# Identify metadata columns that actually exist\nmetadata_cols_present <- intersect(metadata_cols, all_cols)\n\n# Feature columns for family prediction (exclude metadata, keep Category)\nfeature_cols_family <- setdiff(all_cols, metadata_cols_present)\n\n# Additional exclusion: any rank/color columns\nfeature_cols_family <- feature_cols_family[!str_detect(feature_cols_family, \"rank|color|fam_color|rank_in_cat\")]\n\ncat(sprintf(\"Family prediction features: %d features\\n\", length(feature_cols_family)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFamily prediction features: 179 features\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(sprintf(\"Excluded metadata columns: %s\\n\", paste(metadata_cols_present, collapse = \", \")))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nExcluded metadata columns: Family, Category_file, reboot_state, path, file, Hash\n```\n\n\n:::\n:::\n\n\n## Train Category-Specific Models\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Categories to model\ntarget_categories <- c(\"Adware\", \"Riskware\", \"Trojan\")\n\n# Storage for models and training data\ncategory_models <- list()\ncategory_train_data_list <- list()\n\n# Calculate mtry for family models\nmtry_family <- floor(sqrt(length(feature_cols_family)))\n\ncaret_available <- require(\"caret\", quietly = TRUE)\n\ncat(sprintf(\"Family prediction parameters:\\n\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFamily prediction parameters:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(sprintf(\"  Number of trees: %d\\n\", num_trees))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Number of trees: 500\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(sprintf(\"  mtry: %d (sqrt of %d features)\\n\", mtry_family, length(feature_cols_family)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  mtry: 13 (sqrt of 179 features)\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(sprintf(\"  Number of threads: %d\\n\", num_threads))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Number of threads: 8\n```\n\n\n:::\n\n```{.r .cell-code}\n# Train a model for each category\nfor (category in target_categories) {\n  cat(sprintf(\"\\n--- Training Model for %s Family Prediction ---\\n\", category))\n  \n  # Filter data for this category\n  category_data <- andmal_after %>%\n    filter(Category == category)\n  \n  if (nrow(category_data) == 0) {\n    cat(sprintf(\"  WARNING: No samples found for category '%s'. Skipping.\\n\", category))\n    next\n  }\n  \n  # Check family distribution\n  family_dist <- table(category_data$Family)\n  cat(sprintf(\"  Samples in %s category: %d\\n\", category, nrow(category_data)))\n  cat(sprintf(\"  Number of families: %d\\n\", length(unique(category_data$Family))))\n  \n  # Skip if too few families or samples\n  if (length(unique(category_data$Family)) < 2) {\n    cat(sprintf(\"  WARNING: Category '%s' has fewer than 2 families. Skipping.\\n\", category))\n    next\n  }\n  \n  if (nrow(category_data) < 50) {\n    cat(sprintf(\"  WARNING: Category '%s' has fewer than 50 samples. Skipping.\\n\", category))\n    next\n  }\n  \n  # Create train/test split stratified by Family\n  set.seed(42)\n  if (caret_available) {\n    category_train_index <- caret::createDataPartition(\n      category_data$Family,\n      p = train_test_split,\n      list = FALSE,\n      times = 1\n    )\n    category_train <- category_data[category_train_index, ]\n    category_test <- category_data[-category_train_index, ]\n  } else {\n    # Base R stratified sampling by Family\n    families <- unique(category_data$Family)\n    train_indices <- c()\n    for (fam in families) {\n      fam_indices <- which(category_data$Family == fam)\n      if (length(fam_indices) > 1) {\n        n_train <- max(1, round(length(fam_indices) * train_test_split))\n        train_fam_indices <- sample(fam_indices, n_train)\n        train_indices <- c(train_indices, train_fam_indices)\n      } else {\n        # If only one sample, put it in training\n        train_indices <- c(train_indices, fam_indices)\n      }\n    }\n    category_train <- category_data[train_indices, ]\n    category_test <- category_data[-train_indices, ]\n  }\n  \n  cat(sprintf(\"  Training set: %d samples\\n\", nrow(category_train)))\n  cat(sprintf(\"  Test set: %d samples\\n\", nrow(category_test)))\n  \n  # Prepare data for training (ensure data.frame, not tibble)\n  train_family_x <- as.data.frame(category_train[, feature_cols_family, drop = FALSE])\n  train_family_y <- category_train$Family\n  test_family_x <- as.data.frame(category_test[, feature_cols_family, drop = FALSE])\n  test_family_y <- category_test$Family\n  \n  # Ensure Family factor levels match\n  train_family_y <- factor(train_family_y, levels = unique(c(train_family_y, test_family_y)))\n  test_family_y <- factor(test_family_y, levels = levels(train_family_y))\n  \n  # Train model\n  cat(sprintf(\"  Training random forest for %s family prediction...\\n\", category))\n  start_time <- Sys.time()\n  \n  rf_family <- ranger(\n    x = train_family_x,\n    y = train_family_y,\n    num.trees = num_trees,\n    mtry = mtry_family,\n    min.node.size = 1,\n    num.threads = num_threads,\n    classification = TRUE,\n    probability = TRUE,\n    importance = \"impurity\",\n    verbose = FALSE\n  )\n  \n  end_time <- Sys.time()\n  training_time <- difftime(end_time, start_time, units = \"mins\")\n  cat(sprintf(\"  Training completed in %.2f minutes\\n\", as.numeric(training_time)))\n  \n  # Store model and training data (needed for LIME/SHAP)\n  category_models[[category]] <- rf_family\n  \n  # Save model\n  if (!dir.exists(\"data/models\")) {\n    dir.create(\"data/models\", recursive = TRUE)\n  }\n  model_name <- paste0(\"data/models/rf_family_\", tolower(category), \"_model.rds\")\n  saveRDS(rf_family, model_name)\n  cat(sprintf(\"  Saved: %s\\n\", model_name))\n  \n  # Store training data for this category (needed for LIME/SHAP explanations)\n  # Save as data.frame to avoid tibble issues\n  category_train_data_list[[category]] <- list(\n    train_x = train_family_x,\n    train_y = train_family_y\n  )\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n--- Training Model for Adware Family Prediction ---\n  Samples in Adware category: 5142\n  Number of families: 42\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in caret::createDataPartition(category_data$Family, p =\ntrain_test_split, : Some classes have no records ( <unknown>, ackposts, adrd,\nahopc, aiplay, aliyuncs, androrat, andtheft, andup, andut, anydown, apkq,\napofer, appflood, applovin, appoffer, apptrack, appwiz, arpush, autoins,\nautoinst, autosms, aveasms, avpass, badpac, bankbot, basebridge, batmob,\nbatterydoctor, becou, belib, bgserv, bladic, boodroid, boogr, bookmarker, boqx,\nbosuoa, boxer, burneys, buzztouch, caller, callflakes, callpay, cardserv,\ncarey, catchyou, cauly, cdeject, cellagent, cellshark, chatleaker, cheica,\nchiye, chuli, ciban, cimsci, clevernet, clickfraud, cnsms, cnzz, cobcorm,\ncoinge, colordeojosdetubebe, commplat, congur, cooee, cookieman, cova, crytosh,\ncyfin, cynos, d0a7a, dabom, dadmo, dasu, davitor, deblio, dendroid, deng,\ndianjoy, dianru, dingwe, dinvis, dnotua, dorleh, dougalek, droiddreamlight,\ndroidkungfu, droidrooter, droidsheep, drosel, dsploit, easyroot, eicar, enoket,\nerop, ezspy, faceniff, facestealer, fadeb, fakapp, fakeangry, fakeapp,\nfakebank, fakebkupt, fakeflash, fakeinst, fakelogo, fakengry, fakenotify,\nfakerun, faketoken, fakeupdates, fakevoice, fengvi, fituw, fjcon, floodad,\nfobus, focobers, fogo, fraudbet, frelect, funclub, fyec, gamex, gappusin,\ngeinimi, general, gepat, gepew, ggtracker, gibdy, gidby, ginmaster, gizmo,\ngluper, gmobi, golddream, goldentouch, gonesixty, gopnok, gorpo, gploader,\ngrapereh, gribil, gudex, guerrilla, gugi, hamob, hasad, helir, hellospy,\nhiddad, hiddapp, hiddenapp, hijad, hipposms, hoverwatch, hqwar, htmlapp, hypay,\nhyspu, iconosys, ihouse, imlog, inazigram, inazun, indexer, infoleak, infostl,\ninvent, irtard, itracker, jedan, jfpush, jiagu, jisut, jodo, joke, jopsik,\njoye, jsmshider, jsmshideram, kabun, kasandra, kefamad, kingroot, kirko, kmin,\nkoler, koomer, kosat, krefel, ksapp, kyvu, ldpinch, leech, legog, lemon,\nletang, levida, lgbackup, lien, lirose, loapi, locker, lockerpin, lockscreen,\nlotoor, lotracker, maistealer, malapp, marcher, mart, masnu, masplot, maxapp,\nmcare, mecor, metasploit, micropsia, mimobsms, minimob, minmin, mkero,\nmmarketpay, mmmedia, moavt, mobby, mobdown, mobeleader, mobile, mobilepay,\nmobilespy, mobiletracker, mobiletx, mobinauten, mobispy, mobtes, mobwin,\nmoplus, morcut, morepaks, mseg, mspy, mycompany, mytrackp, myvk, nandrobox,\nnativead, nbank, neospy, netshell, nickyspy, nineap, niomin, nisemono, nomibi,\nnotipdownload, obtes, odpa, oneclickfraud, opfake, ormmaad, oveead, oversa,\noverseer, paccy, panev, paycall, pdaspy, penetho, pesabti, phonespy, pinap,\npircob, pjapps, plankton, pletor, podec, poohad, porno, premiumtext, pushad,\npuxis, pyls, qdplugin, qicsomos, qlist, qqspy, qsned, qumi, qysly, raden,\nramnit, razam, rediassi, regon, remoteadmin, reptilicus, reqqap, revmob, reyng,\nrooter, rootnik, rootor, rovelap, roversa, rtalan, rufraud, rusms, sacto,\nsadpor, saiva, sakezon, samsa, sandr, scamapp, scrinject, secapk, secmider,\nsecneo, secretspy, seekdroid, seldor, senddroid, sendpay, shastrosms, shell,\nshixot, shupup, silverpush, simpatchy, simpo,\nSINGLETON:096ad217017728c31ae282605c138236,\nSINGLETON:096ca95d12ed88c4db366ccc71d9ee9d,\nSINGLETON:0983b5ed570e819e7126f78fd2cb532d,\nSINGLETON:099d742032cb2f6d1adac75c13d34fb1,\nSINGLETON:09db7ecd0bd2627ffb2e8efd53ddc7df,\nSINGLETON:09ed0775ee91a8672806586d3ee84e5a,\nSINGLETON:0a2f8c28fe90369ad21312dadc6e4160,\nSINGLETON:0a52101856bd83ae2f36a1ade014f392,\nSINGLETON:0a53d381302b784fb74e126c77648242,\nSINGLETON:0a5d272a5178226e745c7f09692d6b57,\nSINGLETON:0a656b70fb79a1060ec71e8e35d30061,\nSINGLETON:0a9310b6d7da127dd807143473e718ad,\nSINGLETON:0a9b2f5e5d5ae51b1da3ba2f9c75e31a,\nSINGLETON:0ab91dcf030f1fb79c88f2def3353c39,\nSINGLETON:0acc00635c82ac5a32c2d21e662c7e8e,\nSINGLETON:0adbbde4c134888dcb6f3ca1f48dac38,\nSINGLETON:0ae5e12e55f43165eb6c20f9143675e8,\nSINGLETON:0b71b46a13714ed1f60c3a04e5609a1a,\nSINGLETON:0b71e3c35552af26ba7d54a8050bb7f1,\nSINGLETON:0b87b4bf5d2b12505d4d0cfa86195a78,\nSINGLETON:0b8851c1cb2ae05dc755503937ed28ef,\nSINGLETON:0ba40ef74c631aadcfb6d64891d9a156,\nSINGLETON:0ba6cac0f30ed0156ff4d6f1778aef7f,\nSINGLETON:0ba84d7e547ac67f197640288d3b54ec,\nSINGLETON:0bc0ae1af29629c94237d146ea4e6dce,\nSINGLETON:0bcf74c7373fc45b74ff3f6ac4ccc522,\nSINGLETON:0be696ebf2043d814594f59ffa171203,\nSINGLETON:0c06f82a8cdce697b30e09072ad3d45b,\nSINGLETON:0c0aa9185e2eb2a546d76b3bcfadcd6a,\nSINGLETON:0c0ec4bbe866dba01cd918a76e292432,\nSINGLETON:0c34b3493037cadd96afbe18d27347a6,\nSINGLETON:0c4703a2106593e846030a621fdbbcb0,\nSINGLETON:0c584e8667deecac0f8df5842a786791,\nSINGLETON:0c8b4003cca73a85de636dbac93a79d4,\nSINGLETON:0cb29476eab35387a989c155b349cb35,\nSINGLETON:0cf6f3d5342f15e2b0120d15c49284ef,\nSINGLETON:0d02f6a5deaa2bc93043a2beb9ba9908,\nSINGLETON:0d152fbb8831858a911204f46f3068b0,\nSINGLETON:0d2d80e4005ba5276d4c41ed741e001a,\nSINGLETON:0d430f8f15515748117e1f723d3d4e4d,\nSINGLETON:0d4a644aab0fe85df7e0c1c7e6709f61,\nSINGLETON:0d6aedb8cacddedc61231e7311452cc0,\nSINGLETON:0dccbfec7d816dd636a59e4976c6213d,\nSINGLETON:0dcf4eae57ab34a2f671a5b083b70428,\nSINGLETON:0dd224afd9c059aa19bf52b21106764d,\nSINGLETON:0de5a73b2b59c260693d1d894d81f220,\nSINGLETON:0ded3cf9b9434e711f854ffe336aac1d,\nSINGLETON:0dff0fad6359eb49b9974eeeb6a8bf07,\nSINGLETON:0e03a97ddfcf4057dca1fb0af4b7950d,\nSINGLETON:0e2233f4798aaf343d0dadc1d75de447,\nSINGLETON:0e50ef83d90095b69b04f82d4d7fdf26,\nSINGLETON:0e677f9297291acfbad11a196dd01c25,\nSINGLETON:0e6f43a9031d15980939e8959cd61305,\nSINGLETON:0e7f7312e867c7588e878f6399d8303a,\nSINGLETON:0e97cdbe799310a34367003593e76e63,\nSINGLETON:0e9e80428ccdb1f718965af818d5a95c,\nSINGLETON:0eab8749113c498cee8b28a8fc377874,\nSINGLETON:0eb6197748fdb8b996070dd6b73cce71,\nSINGLETON:0ec982786fe3ea919a9775cbf1a8f1b5,\nSINGLETON:0ee55f3dca783178e66b772242de9bf0,\nSINGLETON:0efd33002fb61ab2ca29cdeefd8ab991,\nSINGLETON:0f0126c24e97f0936f482b7d573fcc78,\nSINGLETON:0f09eca307b11b2380237316c01b1f7d,\nSINGLETON:0f25c1f25c89743ca7f60479f8d1eb41,\nSINGLETON:0f2b5f2567b027efcab3dbbb1aff2b3b,\nSINGLETON:0f30c3abcd0858e92e485c2ca8b28021,\nSINGLETON:0f496504e603bcdfed2199c35a191d76,\nSINGLETON:0f53b48c568c7bcdbc6997db6905beb7,\nSINGLETON:0f55ff026669b789ca39b11044031e30,\nSINGLETON:0f560bc8cacbef930e30378eeb7ae00f,\nSINGLETON:0f7882a49d5d345841940da7e0c7fea7,\nSINGLETON:0f87bbf58178e288da01277796be2563,\nSINGLETON:0f882c9eed96f90c0a81243f3323101a,\nSINGLETON:0f895eacd8296e3a25f3de04638dc18e,\nSINGLETON:0f9d936e064161851bfe020286ae4498,\nSINGLETON:0fa7dd08548c99288511aa90e95bc8e4,\nSINGLETON:0fc510adc91eb0879a83bcf3fdfb72df,\nSINGLETON:0ff47691cb02d33d6c8b853a49b5f77c,\nSINGLETON:1012cb7d4ff219e8336b72c002b1578b,\nSINGLETON:102a4087bcc6caf1fd22921857196caa,\nSINGLETON:1031f93e4319a55a4f273c343e26e8f0,\nSINGLETON:10544757a4f2520eba6b441a02d88594,\nSINGLETON:1075baf0040bee353684800baf1d65d7,\nSINGLETON:10ae38393998b33af5d4f10967486038,\nSINGLETON:10ce8fcb3af6d16d299214d11baeb737,\nSINGLETON:10cf8c18c005b94c663eb4cbd9c0ed2b,\nSINGLETON:10d5b5c953a19d7501b938ca680feeda,\nSINGLETON:10d66831a358434963719e469df633b4,\nSINGLETON:10d828be47b4d7751f814c7bd7140024,\nSINGLETON:10d82908d3d9ec9b1fac528d3849659a,\nSINGLETON:11364a36d19af66421aa8b2e7c6a01ef,\nSINGLETON:11369006a71b107c9589df496b78a26c,\nSINGLETON:11414f7d450c053d9b19e3684699c059,\nSINGLETON:11530bf1a2e66aa7df6e8cfe327d9475,\nSINGLETON:11ef6e393851bf909b95f7002ee83b8b,\nSINGLETON:120c61701e264e134a42e500ac768c88,\nSINGLETON:121d985e32cbf3a93a7903d234426a31,\nSINGLETON:122599c3bd6be1be27a59a145a49a24b,\nSINGLETON:123028a9cb36fab2271f71b30b2a5fac,\nSINGLETON:124a967ddc03d4c33eb188a9130228d0,\nSINGLETON:125aa860ca41e57eb47b7afb2316de68,\nSINGLETON:126166462962d3448edd9fc9aa7250cd,\nSINGLETON:129fa59fb6e3ae33f84f26dd5f0c6112,\nSINGLETON:12a276f68f83e834749d49411142c603,\nSINGLETON:12a657c9ed61e209a8eace03e4d22782,\nSINGLETON:12a85ad4add51556b010bb391acc3eb0,\nSINGLETON:12aa184754b1dcd6bca149ee6aa503d6,\nSINGLETON:12d15041e0eb30ab3908e981d03dfbf4,\nSINGLETON:13048f42729aed7489e5c6b39e1d0b8c,\nSINGLETON:1316e3fbae3599da08707643f22ed8fe,\nSINGLETON:13286fbc1e0cf037545f7297378f25e5,\nSINGLETON:132e3461123202a7d2f9d1f8b985c170,\nSINGLETON:1334508bd11b78d99ac6cd07d85237b4,\nSINGLETON:133627c6b434c0bf4adf70f171df5344,\nSINGLETON:133864942bc2c42813c6964947770e31,\nSINGLETON:13584b5f035c0ac43d26b688290fd7f9,\nSINGLETON:135e3852c7d268d95dc478e3e5e019ae,\nSINGLETON:13766d8b4c06057f01ad7820636d373e, SINGLETON:13d35462\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in caret::createDataPartition(category_data$Family, p =\ntrain_test_split, : Some classes have a single record ( batmobi, ganlet, kyhub\n) and these will be selected for the sample\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Training set: 4130 samples\n  Test set: 1012 samples\n  Training random forest for Adware family prediction...\n  Training completed in 0.03 minutes\n  Saved: data/models/rf_family_adware_model.rds\n\n--- Training Model for Riskware Family Prediction ---\n  Samples in Riskware category: 6792\n  Number of families: 18\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in caret::createDataPartition(category_data$Family, p =\ntrain_test_split, : Some classes have no records ( accutrack, ackposts,\nadcolony, adend, adflex, admogo, adrd, adviator, adwo, ahopc, aiplay, airpush,\naliyuncs, androrat, andtheft, andup, andut, apkq, apofer, appad, appflood,\napplovin, appoffer, appsgeyser, apptrack, appwiz, arpush, autoins, autoinst,\nautosms, aveasms, avpass, badpac, baiduprotect, bankbot, basebridge, batmob,\nbatmobi, batterydoctor, becou, belib, bgserv, bladic, boodroid, boogr,\nbookmarker, boqx, bosuoa, boxer, burneys, buzztouch, caller, callflakes,\ncallpay, cardserv, carey, catchyou, cauly, cdeject, cellagent, cellshark,\nchatleaker, cheica, chiye, chuli, ciban, cimsci, clevernet, clickfraud, cnsms,\ncnzz, cobcorm, coinge, colordeojosdetubebe, commplat, congur, cooee, cookieman,\ncova, crytosh, cyfin, cynos, d0a7a, dabom, dadmo, dasu, davitor, deblio,\ndendroid, dianjoy, dianle, dianru, dingwe, dinvis, domob, dorleh, dougalek,\ndowgin, droiddreamlight, droidkungfu, droidrooter, droidsheep, drosel, dsploit,\neasyroot, eicar, enoket, erop, ewind, ezspy, faceniff, facestealer, fadeb,\nfakapp, fakeangry, fakeapp, fakebank, fakebkupt, fakeflash, fakeinst, fakelogo,\nfakengry, fakenotify, fakerun, faketoken, fakeupdates, fakevoice, feiwo,\nfengvi, fictus, fituw, fjcon, floodad, fobus, focobers, fogo, fraudbet,\nfrelect, frupi, funclub, fyec, gamex, ganlet, gappusin, geinimi, general,\ngepat, gepew, ggtracker, gibdy, gidby, ginmaster, gizmo, gluper, gmobi,\ngolddream, goldentouch, gonesixty, gopnok, gorpo, gploader, grapereh, gribil,\ngudex, guerrilla, gugi, hamob, hasad, helir, hellospy, hiddad, hiddapp,\nhiddenad, hiddenapp, hijad, hipposms, hoverwatch, hqwar, htmlapp, hypay, hyspu,\niconosys, igexin, ihouse, imlog, inazigram, inazun, indexer, infoleak, infostl,\ninmobi, inoco, invent, irtard, itracker, jedan, jfpush, jisut, jodo, joke,\njopsik, joye, jsmshider, jsmshideram, kabun, kalfere, kasandra, kefamad, kirko,\nkmin, koler, koomer, kosat, krefel, ksapp, kuguo, kyhub, kyview, kyvu, ldpinch,\nleadbolt, leech, legog, lemon, letang, levida, lgbackup, lien, lirose, loapi,\nlocker, lockerpin, lockscreen, lotoor, lotracker, maistealer, malapp, marcher,\nmart, masnu, masplot, maxapp, mcare, mecor, micropsia, mimobsms, minimob,\nminmin, mkero, mmarketpay, mmmedia, moavt, mobby, mobclick, mobdown,\nmobeleader, mobidash, mobile, mobilespy, mobiletracker, mobiletx, mobinauten,\nmobisec, mobispy, mobtes, mobwin, moplus, morcut, morepaks, mseg, mspy, mulad,\nmycompany, mytrackp, myvk, nandrobox, nativead, nbank, neospy, netshell,\nnickyspy, nineap, niomin, nisemono, nomibi, notipdownload, obtes, odpa,\noneclickfraud, opfake, ormmaad, oveead, oversa, overseer, paccy, pandaad,\npanev, paycall, pdaspy, penetho, pesabti, phonespy, pinap, pircob, pjapps,\nplague, plankton, pletor, podec, poohad, porno, premiumtext, pushad, puxis,\npyls, qdplugin, qicsomos, qlist, qqspy, qsned, qumi, qysly, raden, ramnit,\nrazam, rediassi, regon, remoteadmin, reptilicus, reqqap, reyng, rooter,\nrootnik, rootor, rovelap, roversa, rtalan, rufraud, rusms, sacto, sadpor,\nsaiva, sakezon, samsa, sandr, scamapp, scrinject, secapk, secmider, secretspy,\nseekdroid, seldor, senddroid, sendpay, shastrosms, shedun, shell, shixot,\nshupup, silverpush, simpatchy, simpo,\nSINGLETON:096ad217017728c31ae282605c138236,\nSINGLETON:096ca95d12ed88c4db366ccc71d9ee9d,\nSINGLETON:0983b5ed570e819e7126f78fd2cb532d,\nSINGLETON:099d742032cb2f6d1adac75c13d34fb1,\nSINGLETON:09db7ecd0bd2627ffb2e8efd53ddc7df,\nSINGLETON:09ed0775ee91a8672806586d3ee84e5a,\nSINGLETON:0a2f8c28fe90369ad21312dadc6e4160,\nSINGLETON:0a52101856bd83ae2f36a1ade014f392,\nSINGLETON:0a53d381302b784fb74e126c77648242,\nSINGLETON:0a5d272a5178226e745c7f09692d6b57,\nSINGLETON:0a656b70fb79a1060ec71e8e35d30061,\nSINGLETON:0a9310b6d7da127dd807143473e718ad,\nSINGLETON:0a9b2f5e5d5ae51b1da3ba2f9c75e31a,\nSINGLETON:0ab91dcf030f1fb79c88f2def3353c39,\nSINGLETON:0acc00635c82ac5a32c2d21e662c7e8e,\nSINGLETON:0adbbde4c134888dcb6f3ca1f48dac38,\nSINGLETON:0ae5e12e55f43165eb6c20f9143675e8,\nSINGLETON:0b71b46a13714ed1f60c3a04e5609a1a,\nSINGLETON:0b71e3c35552af26ba7d54a8050bb7f1,\nSINGLETON:0b87b4bf5d2b12505d4d0cfa86195a78,\nSINGLETON:0b8851c1cb2ae05dc755503937ed28ef,\nSINGLETON:0ba40ef74c631aadcfb6d64891d9a156,\nSINGLETON:0ba6cac0f30ed0156ff4d6f1778aef7f,\nSINGLETON:0ba84d7e547ac67f197640288d3b54ec,\nSINGLETON:0bc0ae1af29629c94237d146ea4e6dce,\nSINGLETON:0bcf74c7373fc45b74ff3f6ac4ccc522,\nSINGLETON:0be696ebf2043d814594f59ffa171203,\nSINGLETON:0c06f82a8cdce697b30e09072ad3d45b,\nSINGLETON:0c0aa9185e2eb2a546d76b3bcfadcd6a,\nSINGLETON:0c0ec4bbe866dba01cd918a76e292432,\nSINGLETON:0c34b3493037cadd96afbe18d27347a6,\nSINGLETON:0c4703a2106593e846030a621fdbbcb0,\nSINGLETON:0c584e8667deecac0f8df5842a786791,\nSINGLETON:0c8b4003cca73a85de636dbac93a79d4,\nSINGLETON:0cb29476eab35387a989c155b349cb35,\nSINGLETON:0cf6f3d5342f15e2b0120d15c49284ef,\nSINGLETON:0d02f6a5deaa2bc93043a2beb9ba9908,\nSINGLETON:0d152fbb8831858a911204f46f3068b0,\nSINGLETON:0d2d80e4005ba5276d4c41ed741e001a,\nSINGLETON:0d430f8f15515748117e1f723d3d4e4d,\nSINGLETON:0d4a644aab0fe85df7e0c1c7e6709f61,\nSINGLETON:0d6aedb8cacddedc61231e7311452cc0,\nSINGLETON:0dccbfec7d816dd636a59e4976c6213d,\nSINGLETON:0dcf4eae57ab34a2f671a5b083b70428,\nSINGLETON:0dd224afd9c059aa19bf52b21106764d,\nSINGLETON:0de5a73b2b59c260693d1d894d81f220,\nSINGLETON:0ded3cf9b9434e711f854ffe336aac1d,\nSINGLETON:0dff0fad6359eb49b9974eeeb6a8bf07,\nSINGLETON:0e03a97ddfcf4057dca1fb0af4b7950d,\nSINGLETON:0e2233f4798aaf343d0dadc1d75de447,\nSINGLETON:0e50ef83d90095b69b04f82d4d7fdf26,\nSINGLETON:0e677f9297291acfbad11a196dd01c25,\nSINGLETON:0e6f43a9031d15980939e8959cd61305,\nSINGLETON:0e7f7312e867c7588e878f6399d8303a,\nSINGLETON:0e97cdbe799310a34367003593e76e63,\nSINGLETON:0e9e80428ccdb1f718965af818d5a95c,\nSINGLETON:0eab8749113c498cee8b28a8fc377874,\nSINGLETON:0eb6197748fdb8b996070dd6b73cce71,\nSINGLETON:0ec982786fe3ea919a9775cbf1a8f1b5,\nSINGLETON:0ee55f3dca783178e66b772242de9bf0,\nSINGLETON:0efd33002fb61ab2ca29cdeefd8ab991,\nSINGLETON:0f0126c24e97f0936f482b7d573fcc78,\nSINGLETON:0f09eca307b11b2380237316c01b1f7d,\nSINGLETON:0f25c1f25c89743ca7f60479f8d1eb41,\nSINGLETON:0f2b5f2567b027efcab3dbbb1aff2b3b,\nSINGLETON:0f30c3abcd0858e92e485c2ca8b28021,\nSINGLETON:0f496504e603bcdfed2199c35a191d76,\nSINGLETON:0f53b48c568c7bcdbc6997db6905beb7,\nSINGLETON:0f55ff026669b789ca39b11044031e30,\nSINGLETON:0f560bc8cacbef930e30378eeb7ae00f,\nSINGLETON:0f7882a49d5d345841940da7e0c7fea7,\nSINGLETON:0f87bbf58178e288da01277796be2563,\nSINGLETON:0f882c9eed96f90c0a81243f3323101a,\nSINGLETON:0f895eacd8296e3a25f3de04638dc18e,\nSINGLETON:0f9d936e064161851bfe020286ae4498,\nSINGLETON:0fa7dd08548c99288511aa90e95bc8e4,\nSINGLETON:0fc510adc91eb0879a83bcf3fdfb72df,\nSINGLETON:0ff47691cb02d33d6c8b853a49b5f77c,\nSINGLETON:1012cb7d4ff219e8336b72c002b1578b,\nSINGLETON:102a4087bcc6caf1fd22921857196caa,\nSINGLETON:1031f93e4319a55a4f273c343e26e8f0,\nSINGLETON:10544757a4f2520eba6b441a02d88594,\nSINGLETON:1075baf0040bee353684800baf1d65d7,\nSINGLETON:10ae38393998b33af5d4f10967486038,\nSINGLETON:10ce8fcb3af6d16d299214d11baeb737,\nSINGLETON:10cf8c18c005b94c663eb4cbd9c0ed2b,\nSINGLETON:10d5b5c953a19d7501b938ca680feeda,\nSINGLETON:10d66831a358434963719e469df633b4,\nSINGLETON:10d828be47b4d7751f814c7bd7140024,\nSINGLETON:10d82908d3d9ec9b1fac528d3849659a,\nSINGLETON:11364a36d19af66421aa8b2e7c6a01ef,\nSINGLETON:11369006a71b107c9589df496b78a26c,\nSINGLETON:11414f7d450c053d9b19e3684699c059,\nSINGLETON:11530bf1a2e66aa7df6e8cfe327d9475,\nSINGLETON:11ef6e393851bf909b95f7002ee83b8b,\nSINGLETON:120c61701e264e134a42e500ac768c88,\nSINGLETON:121d985e32cbf3a93a7903d234426a31,\nSINGLETON:122599c3bd6be1be27a59a145a49a24b,\nSINGLETON:123028a9cb36fab2271f71b30b2a5fac,\nSINGLETON:124a967ddc03d4c33eb188a9130228d0,\nSINGLETON:125aa860ca41e57eb47b7afb2316de68,\nSINGLETON:126166462962d3448edd9fc9aa7250cd,\nSINGLETON:129fa59fb6e3ae33f84f26dd5f0c6112,\nSINGLETON:12a276f68f83e834749d49411142c603,\nSINGLETON:12a657c9ed61e209a8eace03e4d22782,\nSINGLETON:12a85ad4add51556b010bb391acc3eb0,\nSINGLETON:12aa184754b1dcd6bca149ee6aa503d6,\nSINGLETON:12d15041e0eb30ab3908e981d03dfbf4,\nSINGLETON:13048f42729aed7489e5c6b39e1d0b8c,\nSINGLETON:1316e3fbae3599da08707643f22ed8fe,\nSINGLETON:13286fbc1e0cf037545f7297378f25e5,\nSINGLETON:132e3461123202a7d2f9d1f8b985c170,\nSINGLETON:1334508bd11b78d99ac6cd07d85237b4, SINGLETON:133627c6b434\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in caret::createDataPartition(category_data$Family, p =\ntrain_test_split, : Some classes have a single record ( kingroot,\ntencentprotect, tordow ) and these will be selected for the sample\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Training set: 5440 samples\n  Test set: 1352 samples\n  Training random forest for Riskware family prediction...\n  Training completed in 0.03 minutes\n  Saved: data/models/rf_family_riskware_model.rds\n\n--- Training Model for Trojan Family Prediction ---\n  Samples in Trojan category: 4025\n  Number of families: 37\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in caret::createDataPartition(category_data$Family, p =\ntrain_test_split, : Some classes have no records ( accutrack, ackposts,\nadcolony, adend, adflex, admogo, adrd, adviator, adwo, ahopc, aiplay, airpush,\naliyuncs, androrat, andtheft, andup, andut, anydown, apkq, apofer, appad,\nappflood, applovin, appoffer, appsgeyser, apptrack, appwiz, arpush, aveasms,\navpass, badpac, baiduprotect, bankbot, batmob, batmobi, batterydoctor, becou,\nbelib, bgserv, bladic, boodroid, bookmarker, boqx, bosuoa, boxer, burneys,\nbuzztouch, caller, callflakes, callpay, cardserv, carey, catchyou, cauly,\ncdeject, cellagent, cellshark, chatleaker, cheica, chiye, chuli, ciban, cimsci,\nclevernet, clickfraud, cnzz, cobcorm, colordeojosdetubebe, commplat, congur,\ncooee, cookieman, cova, crytosh, cyfin, cynos, d0a7a, dabom, dadmo, dasu,\ndavitor, deblio, dendroid, deng, dianjoy, dianle, dianru, dingwe, dinvis,\ndnotua, domob, dorleh, dougalek, dowgin, droidkungfu, droidrooter, droidsheep,\ndsploit, easyroot, eicar, enoket, erop, ewind, ezspy, faceniff, facestealer,\nfadeb, fakapp, fakeangry, fakeapp, fakebank, fakebkupt, fakeflash, fakeinst,\nfakelogo, fakengry, fakenotify, fakerun, faketoken, fakeupdates, fakevoice,\nfeiwo, fengvi, fictus, fituw, fjcon, floodad, fobus, focobers, fogo, fraudbet,\nfrelect, frupi, funclub, fyec, gamex, ganlet, geinimi, general, gepat, gepew,\nggtracker, gibdy, gidby, gizmo, gmobi, golddream, goldentouch, gonesixty,\ngopnok, gorpo, gploader, grapereh, gribil, gudex, guerrilla, gugi, hamob,\nhasad, helir, hellospy, hiddad, hiddapp, hiddenad, hijad, hipposms, hoverwatch,\nhqwar, htmlapp, igexin, ihouse, imlog, inazigram, inazun, indexer, infoleak,\ninfostl, inmobi, inoco, invent, irtard, itracker, jedan, jfpush, jiagu, jisut,\njodo, joke, jopsik, joye, jsmshider, jsmshideram, kabun, kalfere, kasandra,\nkefamad, kingroot, kirko, kmin, koler, koomer, kosat, krefel, ksapp, kuguo,\nkyhub, kyview, kyvu, ldpinch, leadbolt, leech, legog, lemon, letang, levida,\nlgbackup, lien, lirose, loapi, locker, lockerpin, lockscreen, lotracker,\nmaistealer, malapp, marcher, mart, masnu, masplot, maxapp, mcare, mecor,\nmetasploit, micropsia, mimobsms, minimob, minmin, mkero, mmarketpay, mmmedia,\nmoavt, mobby, mobclick, mobdown, mobeleader, mobidash, mobile, mobilepay,\nmobilespy, mobiletracker, mobiletx, mobinauten, mobisec, mobispy, mobwin,\nmoplus, morcut, morepaks, mspy, mulad, mycompany, myvk, nandrobox, nativead,\nnbank, neospy, netshell, nickyspy, nineap, niomin, nisemono, nomibi,\nnotipdownload, odpa, oneclickfraud, opfake, ormmaad, oversa, overseer, paccy,\npandaad, panev, paycall, pdaspy, penetho, pesabti, phonespy, pinap, pircob,\npjapps, plague, plankton, pletor, podec, poohad, porno, premiumtext, pushad,\npuxis, pyls, qdplugin, qicsomos, qlist, qqspy, qsned, qumi, raden, ramnit,\nrazam, rediassi, regon, remoteadmin, reptilicus, reqqap, revmob, reyng, rooter,\nrootor, rovelap, roversa, rtalan, rufraud, sacto, sadpor, saiva, sakezon,\nsamsa, sandr, scamapp, scrinject, secapk, secmider, secneo, secretspy,\nseekdroid, seldor, senddroid, sendpay, shastrosms, shedun, shell, shixot,\nshupup, silverpush, simpatchy, simpo,\nSINGLETON:096ad217017728c31ae282605c138236,\nSINGLETON:096ca95d12ed88c4db366ccc71d9ee9d,\nSINGLETON:0983b5ed570e819e7126f78fd2cb532d,\nSINGLETON:099d742032cb2f6d1adac75c13d34fb1,\nSINGLETON:09db7ecd0bd2627ffb2e8efd53ddc7df,\nSINGLETON:09ed0775ee91a8672806586d3ee84e5a,\nSINGLETON:0a2f8c28fe90369ad21312dadc6e4160,\nSINGLETON:0a52101856bd83ae2f36a1ade014f392,\nSINGLETON:0a53d381302b784fb74e126c77648242,\nSINGLETON:0a5d272a5178226e745c7f09692d6b57,\nSINGLETON:0a656b70fb79a1060ec71e8e35d30061,\nSINGLETON:0a9310b6d7da127dd807143473e718ad,\nSINGLETON:0a9b2f5e5d5ae51b1da3ba2f9c75e31a,\nSINGLETON:0ab91dcf030f1fb79c88f2def3353c39,\nSINGLETON:0acc00635c82ac5a32c2d21e662c7e8e,\nSINGLETON:0adbbde4c134888dcb6f3ca1f48dac38,\nSINGLETON:0ae5e12e55f43165eb6c20f9143675e8,\nSINGLETON:0b71b46a13714ed1f60c3a04e5609a1a,\nSINGLETON:0b71e3c35552af26ba7d54a8050bb7f1,\nSINGLETON:0b87b4bf5d2b12505d4d0cfa86195a78,\nSINGLETON:0b8851c1cb2ae05dc755503937ed28ef,\nSINGLETON:0ba40ef74c631aadcfb6d64891d9a156,\nSINGLETON:0ba6cac0f30ed0156ff4d6f1778aef7f,\nSINGLETON:0ba84d7e547ac67f197640288d3b54ec,\nSINGLETON:0bc0ae1af29629c94237d146ea4e6dce,\nSINGLETON:0bcf74c7373fc45b74ff3f6ac4ccc522,\nSINGLETON:0be696ebf2043d814594f59ffa171203,\nSINGLETON:0c06f82a8cdce697b30e09072ad3d45b,\nSINGLETON:0c0aa9185e2eb2a546d76b3bcfadcd6a,\nSINGLETON:0c0ec4bbe866dba01cd918a76e292432,\nSINGLETON:0c34b3493037cadd96afbe18d27347a6,\nSINGLETON:0c4703a2106593e846030a621fdbbcb0,\nSINGLETON:0c584e8667deecac0f8df5842a786791,\nSINGLETON:0c8b4003cca73a85de636dbac93a79d4,\nSINGLETON:0cb29476eab35387a989c155b349cb35,\nSINGLETON:0cf6f3d5342f15e2b0120d15c49284ef,\nSINGLETON:0d02f6a5deaa2bc93043a2beb9ba9908,\nSINGLETON:0d152fbb8831858a911204f46f3068b0,\nSINGLETON:0d2d80e4005ba5276d4c41ed741e001a,\nSINGLETON:0d430f8f15515748117e1f723d3d4e4d,\nSINGLETON:0d4a644aab0fe85df7e0c1c7e6709f61,\nSINGLETON:0d6aedb8cacddedc61231e7311452cc0,\nSINGLETON:0dccbfec7d816dd636a59e4976c6213d,\nSINGLETON:0dcf4eae57ab34a2f671a5b083b70428,\nSINGLETON:0dd224afd9c059aa19bf52b21106764d,\nSINGLETON:0de5a73b2b59c260693d1d894d81f220,\nSINGLETON:0ded3cf9b9434e711f854ffe336aac1d,\nSINGLETON:0dff0fad6359eb49b9974eeeb6a8bf07,\nSINGLETON:0e03a97ddfcf4057dca1fb0af4b7950d,\nSINGLETON:0e2233f4798aaf343d0dadc1d75de447,\nSINGLETON:0e50ef83d90095b69b04f82d4d7fdf26,\nSINGLETON:0e677f9297291acfbad11a196dd01c25,\nSINGLETON:0e6f43a9031d15980939e8959cd61305,\nSINGLETON:0e7f7312e867c7588e878f6399d8303a,\nSINGLETON:0e97cdbe799310a34367003593e76e63,\nSINGLETON:0e9e80428ccdb1f718965af818d5a95c,\nSINGLETON:0eab8749113c498cee8b28a8fc377874,\nSINGLETON:0eb6197748fdb8b996070dd6b73cce71,\nSINGLETON:0ec982786fe3ea919a9775cbf1a8f1b5,\nSINGLETON:0ee55f3dca783178e66b772242de9bf0,\nSINGLETON:0efd33002fb61ab2ca29cdeefd8ab991,\nSINGLETON:0f0126c24e97f0936f482b7d573fcc78,\nSINGLETON:0f09eca307b11b2380237316c01b1f7d,\nSINGLETON:0f25c1f25c89743ca7f60479f8d1eb41,\nSINGLETON:0f2b5f2567b027efcab3dbbb1aff2b3b,\nSINGLETON:0f30c3abcd0858e92e485c2ca8b28021,\nSINGLETON:0f496504e603bcdfed2199c35a191d76,\nSINGLETON:0f53b48c568c7bcdbc6997db6905beb7,\nSINGLETON:0f55ff026669b789ca39b11044031e30,\nSINGLETON:0f560bc8cacbef930e30378eeb7ae00f,\nSINGLETON:0f7882a49d5d345841940da7e0c7fea7,\nSINGLETON:0f87bbf58178e288da01277796be2563,\nSINGLETON:0f882c9eed96f90c0a81243f3323101a,\nSINGLETON:0f895eacd8296e3a25f3de04638dc18e,\nSINGLETON:0f9d936e064161851bfe020286ae4498,\nSINGLETON:0fa7dd08548c99288511aa90e95bc8e4,\nSINGLETON:0fc510adc91eb0879a83bcf3fdfb72df,\nSINGLETON:0ff47691cb02d33d6c8b853a49b5f77c,\nSINGLETON:1012cb7d4ff219e8336b72c002b1578b,\nSINGLETON:102a4087bcc6caf1fd22921857196caa,\nSINGLETON:1031f93e4319a55a4f273c343e26e8f0,\nSINGLETON:10544757a4f2520eba6b441a02d88594,\nSINGLETON:1075baf0040bee353684800baf1d65d7,\nSINGLETON:10ae38393998b33af5d4f10967486038,\nSINGLETON:10ce8fcb3af6d16d299214d11baeb737,\nSINGLETON:10cf8c18c005b94c663eb4cbd9c0ed2b,\nSINGLETON:10d5b5c953a19d7501b938ca680feeda,\nSINGLETON:10d66831a358434963719e469df633b4,\nSINGLETON:10d828be47b4d7751f814c7bd7140024,\nSINGLETON:10d82908d3d9ec9b1fac528d3849659a,\nSINGLETON:11364a36d19af66421aa8b2e7c6a01ef,\nSINGLETON:11369006a71b107c9589df496b78a26c,\nSINGLETON:11414f7d450c053d9b19e3684699c059,\nSINGLETON:11530bf1a2e66aa7df6e8cfe327d9475,\nSINGLETON:11ef6e393851bf909b95f7002ee83b8b,\nSINGLETON:120c61701e264e134a42e500ac768c88,\nSINGLETON:121d985e32cbf3a93a7903d234426a31,\nSINGLETON:122599c3bd6be1be27a59a145a49a24b,\nSINGLETON:123028a9cb36fab2271f71b30b2a5fac,\nSINGLETON:124a967ddc03d4c33eb188a9130228d0,\nSINGLETON:125aa860ca41e57eb47b7afb2316de68,\nSINGLETON:126166462962d3448edd9fc9aa7250cd,\nSINGLETON:129fa59fb6e3ae33f84f26dd5f0c6112,\nSINGLETON:12a276f68f83e834749d49411142c603,\nSINGLETON:12a657c9ed61e209a8eace03e4d22782,\nSINGLETON:12a85ad4add51556b010bb391acc3eb0,\nSINGLETON:12aa184754b1dcd6bca149ee6aa503d6,\nSINGLETON:12d15041e0eb30ab3908e981d03dfbf4,\nSINGLETON:13048f42729aed7489e5c6b39e1d0b8c,\nSINGLETON:1316e3fbae3599da08707643f22ed8fe,\nSINGLETON:13286fbc1e0cf037545f7297378f25e5,\nSINGLETON:132e3461123202a7d2f9d1f8b985c170,\nSINGLETON:1334508bd11b78d99ac6cd07d85237b4,\nSINGLETON:133627c6b434c0bf4adf70f171df5344,\nSINGLETON:133864942bc2c42813c6964947770e31,\nSINGLETON:13584b5f035c0ac43d26b688290fd7f9, SINGLETON:135e3852c7d268d95dc478\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in caret::createDataPartition(category_data$Family, p =\ntrain_test_split, : Some classes have a single record ( coinge, obtes, uupay )\nand these will be selected for the sample\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Training set: 3232 samples\n  Test set: 793 samples\n  Training random forest for Trojan family prediction...\n  Training completed in 0.02 minutes\n  Saved: data/models/rf_family_trojan_model.rds\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\nAll family models trained successfully.\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nAll family models trained successfully.\n```\n\n\n:::\n:::\n\n\n## Load Selected Instances\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Set seed for reproducibility\nset.seed(42)\n\n# Load the selected instances from category.qmd\nif (file.exists(\"data/processed/selected_instances.rds\")) {\n  selected_instances_df <- readRDS(\"data/processed/selected_instances.rds\")\n  cat(\"Loaded selected instances from category.qmd\\n\")\n  cat(sprintf(\"Selected instances: %s\\n\", paste(selected_instances_df$Category, collapse = \", \")))\n} else {\n  stop(\"Selected instances file not found. Please run category.qmd first to generate selected_instances.rds\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLoaded selected instances from category.qmd\nSelected instances: Adware, Riskware, Trojan\n```\n\n\n:::\n\n```{.r .cell-code}\n# Extract feature matrices for explanations (same pattern as category.qmd)\nselected_instances_x <- selected_instances_df[, feature_cols_family, drop = FALSE]\n\ncat(\"\\nInstance selection complete.\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nInstance selection complete.\n```\n\n\n:::\n:::\n\n\n## Model Interpretability\n\n### Adware Family Model Explanations\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Set seed for reproducibility\nset.seed(42)\n\ncategory <- \"Adware\"\n\nif (category %in% names(category_models)) {\n  cat(sprintf(\"\\n=== %s Family Model Explanations ===\\n\", category))\n  \n  # Get the corresponding instance (same pattern as category.qmd)\n  instance_idx <- which(selected_instances_df$Category == category)\n  if (length(instance_idx) == 0) {\n    cat(sprintf(\"No instance found for category %s\\n\", category))\n  } else {\n    # Get training data for this category\n    train_family_x <- category_train_data_list[[category]]$train_x\n    model <- category_models[[category]]\n    \n    #### LIME Explanation\n    cat(sprintf(\"\\n--- LIME Explanation for %s Instance ---\\n\", category))\n    \n    # Create LIME explainer\n    explainer_family <- lime(\n      train_family_x,\n      model = model,\n      bin_continuous = TRUE,\n      n_bins = 5\n    )\n    \n    # Extract instance (same pattern as category.qmd)\n    instance_x <- as.data.frame(selected_instances_x[instance_idx, , drop = FALSE])\n    \n    lime_explanation <- lime::explain(\n      instance_x,\n      explainer = explainer_family,\n      n_features = 10,\n      n_permutations = 5000,\n      n_labels = 1\n    )\n    \n    cat(\"LIME Explanation:\\n\")\n    # Ensure explanation has proper structure for plotting\n    if (nrow(lime_explanation) > 0) {\n      # If explanation doesn't have 'case' column, add it\n      if (!\"case\" %in% colnames(lime_explanation)) {\n        lime_explanation$case <- 1\n      }\n      print(plot_features(lime_explanation))\n    } else {\n      cat(\"Warning: LIME explanation is empty. Skipping plot.\\n\")\n    }\n    \n    #### Per-Instance SHAP Values\n    cat(sprintf(\"\\n--- Per-Instance SHAP Values for %s Instance ---\\n\", category))\n    \n    # Create prediction function for fastshap\n    pred_wrapper_family <- function(object, newdata) {\n      pred <- predict(object, newdata)\n      return(pred$predictions)\n    }\n    \n    # Ensure newdata is a data.frame (same pattern as category.qmd)\n    newdata_df <- as.data.frame(selected_instances_x[instance_idx, , drop = FALSE])\n    \n    shap_instance <- explain(\n      model,\n      X = train_family_x,\n      newdata = newdata_df,\n      pred_wrapper = pred_wrapper_family,\n      nsim = 100\n    )\n    \n    # Get predicted class probabilities\n    pred_probs <- predict(model, newdata_df)$predictions\n    pred_class <- colnames(pred_probs)[which.max(pred_probs)]\n    \n    # Handle SHAP values - fastshap returns a matrix/data.frame\n    if (is.data.frame(shap_instance) || is.matrix(shap_instance)) {\n      # Check if columns are classes or features\n      if (pred_class %in% colnames(shap_instance)) {\n        shap_df <- data.frame(\n          feature = rownames(shap_instance),\n          shap_value = shap_instance[[pred_class]]\n        )\n      } else if (ncol(shap_instance) == length(feature_cols_family)) {\n        # Columns are features\n        shap_df <- data.frame(\n          feature = colnames(shap_instance),\n          shap_value = as.numeric(shap_instance[1, ])\n        )\n      } else {\n        # Try to extract first row or first column\n        if (nrow(shap_instance) == 1) {\n          shap_df <- data.frame(\n            feature = colnames(shap_instance),\n            shap_value = as.numeric(shap_instance[1, ])\n          )\n        } else {\n          shap_df <- data.frame(\n            feature = rownames(shap_instance),\n            shap_value = as.numeric(shap_instance[, 1])\n          )\n        }\n      }\n      \n      shap_df <- shap_df %>%\n        arrange(desc(abs(shap_value))) %>%\n        head(20)\n      \n      cat(sprintf(\"Top 20 SHAP values (predicted class: %s):\\n\", pred_class))\n      print(shap_df)\n      \n      # Create visualization\n      p_shap <- ggplot(shap_df, aes(x = reorder(feature, shap_value), y = shap_value)) +\n        geom_col(aes(fill = shap_value > 0)) +\n        scale_fill_manual(\n          values = c(\"TRUE\" = \"#2E8B57\", \"FALSE\" = \"#DC143C\"),\n          labels = c(\"TRUE\" = \"Positive\", \"FALSE\" = \"Negative\"),\n          name = \"SHAP Value\"\n        ) +\n        coord_flip() +\n        labs(\n          title = sprintf(\"SHAP Values - %s Instance (%s Family Model)\", category, pred_class),\n          subtitle = sprintf(\"Top 20 features by absolute SHAP value\"),\n          x = \"Feature\",\n          y = \"SHAP Value\"\n        ) +\n        theme_minimal() +\n        theme(\n          plot.title = element_text(size = 14, face = \"bold\"),\n          plot.subtitle = element_text(size = 12),\n          axis.text.y = element_text(size = 8)\n        )\n      \n      print(p_shap)\n    } else {\n      cat(sprintf(\"SHAP values format not recognized for %s instance\\n\", category))\n    }\n  }\n} else {\n  cat(sprintf(\"Model for %s not found.\\n\", category))\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== Adware Family Model Explanations ===\n\n--- LIME Explanation for Adware Instance ---\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Data contains numeric columns with zero variance\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Memory_OpenSSLSockets does not contain enough variance to use quantile\nbinning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Process_android.app.ActivityManager_killBackgroundProcesses does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Command_java.lang.Runtime_exec does not contain enough variance to\nuse quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Command_java.lang.ProcessBuilder_start does not contain enough\nvariance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_WebView_android.webkit.WebView_loadData does not contain enough\nvariance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_WebView_android.webkit.WebView_loadDataWithBaseURL does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_WebView_android.webkit.WebView_evaluateJavascript does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_WebView_android.webkit.WebView_setWebContentsDebuggingEnabled does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_FileIO_android.content.ContextWrapper_openFileOutput does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_FileIO_android.content.ContextWrapper_deleteFile does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.content.ContextWrapper_openOrCreateDatabase does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.content.ContextWrapper_databaseList does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.database.sqlite.SQLiteDatabase_insert does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.database.sqlite.SQLiteDatabase_insertOrThrow does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning:\nAPI_Database_android.database.sqlite.SQLiteDatabase_insertWithOnConflict does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning:\nAPI_Database_android.database.sqlite.SQLiteDatabase_openOrCreateDatabase does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.database.sqlite.SQLiteDatabase_query does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.database.sqlite.SQLiteDatabase_queryWithFactory\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.database.sqlite.SQLiteDatabase_update does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning:\nAPI_Database_android.database.sqlite.SQLiteDatabase_updateWithOnConflict does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_IPC_android.content.ContextWrapper_sendStickyBroadcast does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_IPC_android.content.ContextWrapper_startActivity does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_IPC_android.content.ContextWrapper_stopService does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.telephony.TelephonyManager_getLine1Number does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.telephony.TelephonyManager_getSimOperatorName\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.net.wifi.WifiInfo_getBSSID does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.net.wifi.WifiInfo_getIpAddress does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.net.wifi.WifiInfo_getNetworkId does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.telephony.TelephonyManager_getSimCountryIso\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning:\nAPI_DeviceInfo_android.telephony.TelephonyManager_getDeviceSoftwareVersion does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.os.Debug_isDebuggerConnected does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DexClassLoader_dalvik.system.BaseDexClassLoader_findResources does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DexClassLoader_dalvik.system.DexFile_loadDex does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DexClassLoader_dalvik.system.DexFile_loadClass does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning:\nAPI_SystemManager_android.app.ApplicationPackageManager_setComponentEnabledSetting\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_SystemManager_android.app.NotificationManager_notify does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_SystemManager_android.telephony.TelephonyManager_listen does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_SMS_android.telephony.SmsManager_sendTextMessage does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.content.ContentResolver_insert does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.content.ContentResolver_delete does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.accounts.AccountManager_getAccountsByType does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.accounts.AccountManager_getAccounts does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.location.Location_getLatitude does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.location.Location_getLongitude does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.media.AudioRecord_startRecording does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.media.MediaRecorder_start does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: location_calls does not contain enough variance to use quantile\nbinning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: mic_calls does not contain enough variance to use quantile binning.\nUsing standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLIME Explanation:\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: `aes_()` was deprecated in ggplot2 3.0.0.\n Please use tidy evaluation idioms with `aes()`\n The deprecated feature was likely used in the lime package.\n  Please report the issue at <https://github.com/thomasp85/lime/issues>.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](family_files/figure-html/adware-lime-shap-1.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n--- Per-Instance SHAP Values for Adware Instance ---\nTop 20 SHAP values (predicted class: inoco):\n                                                                     feature\n1                                                            Memory_PssTotal\n2                        API_Binder_android.app.ContextImpl_registerReceiver\n3           API_DexClassLoader_dalvik.system.BaseDexClassLoader_findResource\n4                                                             accounts_calls\n5                                                              log_env_probe\n6                                                        Memory_PrivateDirty\n7                                              Network_TotalTransmittedBytes\n8                       API_IPC_android.content.ContextWrapper_startActivity\n9                                                                    has_ids\n10                                                        Memory_AppContexts\n11                                           Network_TotalTransmittedPackets\n12                                                            log_NetTxBytes\n13                                                        Memory_ParcelCount\n14                                                                 env_calls\n15                                                       Memory_ProxyBinders\n16 API_DeviceData_android.app.ApplicationPackageManager_getInstalledPackages\n17                      API_IPC_android.content.ContextWrapper_sendBroadcast\n18                                                       total_DB_read_calls\n19                      API_DeviceData_android.content.ContentResolver_query\n20                                                            Logcat_warning\n      shap_value\n1  -2.962682e-19\n2  -2.695528e-19\n3  -2.540425e-19\n4  -2.233777e-19\n5  -1.768495e-19\n6  -1.743327e-19\n7  -1.722775e-19\n8  -1.689287e-19\n9  -1.551246e-19\n10 -1.404467e-19\n11  1.384346e-19\n12 -1.277563e-19\n13 -1.254161e-19\n14 -1.253353e-19\n15  1.235193e-19\n16 -1.225459e-19\n17 -1.216127e-19\n18  1.173150e-19\n19 -1.137575e-19\n20  1.124131e-19\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](family_files/figure-html/adware-lime-shap-2.png){width=672}\n:::\n:::\n\n\n### Riskware Family Model Explanations\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Set seed for reproducibility\nset.seed(42)\n\ncategory <- \"Riskware\"\n\nif (category %in% names(category_models)) {\n  cat(sprintf(\"\\n=== %s Family Model Explanations ===\\n\", category))\n  \n  # Get the corresponding instance (same pattern as category.qmd)\n  instance_idx <- which(selected_instances_df$Category == category)\n  if (length(instance_idx) == 0) {\n    cat(sprintf(\"No instance found for category %s\\n\", category))\n  } else {\n    # Get training data for this category\n    train_family_x <- category_train_data_list[[category]]$train_x\n    model <- category_models[[category]]\n    \n    #### LIME Explanation\n    cat(sprintf(\"\\n--- LIME Explanation for %s Instance ---\\n\", category))\n    \n    # Create LIME explainer\n    explainer_family <- lime(\n      train_family_x,\n      model = model,\n      bin_continuous = TRUE,\n      n_bins = 5\n    )\n    \n    # Extract instance (same pattern as category.qmd)\n    instance_x <- as.data.frame(selected_instances_x[instance_idx, , drop = FALSE])\n    \n    lime_explanation <- lime::explain(\n      instance_x,\n      explainer = explainer_family,\n      n_features = 10,\n      n_permutations = 5000,\n      n_labels = 1\n    )\n    \n    cat(\"LIME Explanation:\\n\")\n    # Ensure explanation has proper structure for plotting\n    if (nrow(lime_explanation) > 0) {\n      # If explanation doesn't have 'case' column, add it\n      if (!\"case\" %in% colnames(lime_explanation)) {\n        lime_explanation$case <- 1\n      }\n      print(plot_features(lime_explanation))\n    } else {\n      cat(\"Warning: LIME explanation is empty. Skipping plot.\\n\")\n    }\n    \n    #### Per-Instance SHAP Values\n    cat(sprintf(\"\\n--- Per-Instance SHAP Values for %s Instance ---\\n\", category))\n    \n    # Create prediction function for fastshap\n    pred_wrapper_family <- function(object, newdata) {\n      pred <- predict(object, newdata)\n      return(pred$predictions)\n    }\n    \n    # Ensure newdata is a data.frame (same pattern as category.qmd)\n    newdata_df <- as.data.frame(selected_instances_x[instance_idx, , drop = FALSE])\n    \n    shap_instance <- explain(\n      model,\n      X = train_family_x,\n      newdata = newdata_df,\n      pred_wrapper = pred_wrapper_family,\n      nsim = 100\n    )\n    \n    # Get predicted class probabilities\n    pred_probs <- predict(model, newdata_df)$predictions\n    pred_class <- colnames(pred_probs)[which.max(pred_probs)]\n    \n    # Handle SHAP values - fastshap returns a matrix/data.frame\n    if (is.data.frame(shap_instance) || is.matrix(shap_instance)) {\n      # Check if columns are classes or features\n      if (pred_class %in% colnames(shap_instance)) {\n        shap_df <- data.frame(\n          feature = rownames(shap_instance),\n          shap_value = shap_instance[[pred_class]]\n        )\n      } else if (ncol(shap_instance) == length(feature_cols_family)) {\n        # Columns are features\n        shap_df <- data.frame(\n          feature = colnames(shap_instance),\n          shap_value = as.numeric(shap_instance[1, ])\n        )\n      } else {\n        # Try to extract first row or first column\n        if (nrow(shap_instance) == 1) {\n          shap_df <- data.frame(\n            feature = colnames(shap_instance),\n            shap_value = as.numeric(shap_instance[1, ])\n          )\n        } else {\n          shap_df <- data.frame(\n            feature = rownames(shap_instance),\n            shap_value = as.numeric(shap_instance[, 1])\n          )\n        }\n      }\n      \n      shap_df <- shap_df %>%\n        arrange(desc(abs(shap_value))) %>%\n        head(20)\n      \n      cat(sprintf(\"Top 20 SHAP values (predicted class: %s):\\n\", pred_class))\n      print(shap_df)\n      \n      # Create visualization\n      p_shap <- ggplot(shap_df, aes(x = reorder(feature, shap_value), y = shap_value)) +\n        geom_col(aes(fill = shap_value > 0)) +\n        scale_fill_manual(\n          values = c(\"TRUE\" = \"#2E8B57\", \"FALSE\" = \"#DC143C\"),\n          labels = c(\"TRUE\" = \"Positive\", \"FALSE\" = \"Negative\"),\n          name = \"SHAP Value\"\n        ) +\n        coord_flip() +\n        labs(\n          title = sprintf(\"SHAP Values - %s Instance (%s Family Model)\", category, pred_class),\n          subtitle = sprintf(\"Top 20 features by absolute SHAP value\"),\n          x = \"Feature\",\n          y = \"SHAP Value\"\n        ) +\n        theme_minimal() +\n        theme(\n          plot.title = element_text(size = 14, face = \"bold\"),\n          plot.subtitle = element_text(size = 12),\n          axis.text.y = element_text(size = 8)\n        )\n      \n      print(p_shap)\n    } else {\n      cat(sprintf(\"SHAP values format not recognized for %s instance\\n\", category))\n    }\n  }\n} else {\n  cat(sprintf(\"Model for %s not found.\\n\", category))\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== Riskware Family Model Explanations ===\n\n--- LIME Explanation for Riskware Instance ---\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Data contains numeric columns with zero variance\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Memory_OpenSSLSockets does not contain enough variance to use quantile\nbinning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Memory_WebViews does not contain enough variance to use quantile\nbinning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Process_android.app.ActivityManager_killBackgroundProcesses does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_WebView_android.webkit.WebView_loadUrl does not contain enough\nvariance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_WebView_android.webkit.WebView_loadData does not contain enough\nvariance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_WebView_android.webkit.WebView_loadDataWithBaseURL does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_WebView_android.webkit.WebView_addJavascriptInterface does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_WebView_android.webkit.WebView_evaluateJavascript does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_WebView_android.webkit.WebView_setWebContentsDebuggingEnabled does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_FileIO_android.content.ContextWrapper_openFileOutput does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.content.ContextWrapper_openOrCreateDatabase does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.database.sqlite.SQLiteDatabase_insert does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.database.sqlite.SQLiteDatabase_insertOrThrow does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning:\nAPI_Database_android.database.sqlite.SQLiteDatabase_insertWithOnConflict does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning:\nAPI_Database_android.database.sqlite.SQLiteDatabase_openOrCreateDatabase does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.database.sqlite.SQLiteDatabase_update does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning:\nAPI_Database_android.database.sqlite.SQLiteDatabase_updateWithOnConflict does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_IPC_android.content.ContextWrapper_startActivity does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_IPC_android.content.ContextWrapper_stopService does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.telephony.TelephonyManager_getLine1Number does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.telephony.TelephonyManager_getNetworkOperator\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.telephony.TelephonyManager_getSimOperatorName\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.net.wifi.WifiInfo_getBSSID does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.net.wifi.WifiInfo_getIpAddress does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.net.wifi.WifiInfo_getNetworkId does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.telephony.TelephonyManager_getSimCountryIso\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.telephony.TelephonyManager_getSimSerialNumber\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning:\nAPI_DeviceInfo_android.telephony.TelephonyManager_getDeviceSoftwareVersion does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.os.Debug_isDebuggerConnected does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DexClassLoader_dalvik.system.BaseDexClassLoader_findResource does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DexClassLoader_dalvik.system.BaseDexClassLoader_findResources does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning:\nAPI_SystemManager_android.app.ApplicationPackageManager_setComponentEnabledSetting\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_SystemManager_android.app.NotificationManager_notify does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_SystemManager_android.telephony.TelephonyManager_listen does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_SMS_android.telephony.SmsManager_sendTextMessage does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.content.ContentResolver_insert does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.content.ContentResolver_delete does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.accounts.AccountManager_getAccountsByType does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.accounts.AccountManager_getAccounts does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.location.Location_getLatitude does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.location.Location_getLongitude does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: webview_calls does not contain enough variance to use quantile\nbinning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: log_WebView_calls does not contain enough variance to use quantile\nbinning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: location_calls does not contain enough variance to use quantile\nbinning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLIME Explanation:\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](family_files/figure-html/riskware-lime-shap-1.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n--- Per-Instance SHAP Values for Riskware Instance ---\nTop 20 SHAP values (predicted class: <unknown>):\n                                                                            feature\n1                     API_DeviceInfo_android.telephony.TelephonyManager_getDeviceId\n2                                                                  PII_access_count\n3                                                                    Logcat_warning\n4                                    API_DeviceData_android.os.SystemProperties_get\n5                                API_Crypto-Hash_java.security.MessageDigest_digest\n6                                                                       shared_frac\n7                                             API_Base64_android.util.Base64_encode\n8                           API_FileIO_android.content.ContextWrapper_openFileInput\n9                           API_IPC_android.content.ContextWrapper_registerReceiver\n10                                                              Memory_ViewRootImpl\n11                                                                     Logcat_total\n12                                                                  Memory_HeapFree\n13                                                    Network_TotalTransmittedBytes\n14                                                                 log_Logcat_total\n15        API_DeviceData_android.app.ApplicationPackageManager_getInstalledPackages\n16 API_Network_com.android.okhttp.internal.huc.HttpURLConnectionImpl_getInputStream\n17                                                                  env_probe_count\n18                                                                    log_env_probe\n19                                                                     Logcat_debug\n20                API_DeviceInfo_android.telephony.TelephonyManager_getSubscriberId\n      shap_value\n1   1.005820e-18\n2   9.965301e-19\n3   5.965838e-19\n4   5.881081e-19\n5   5.822791e-19\n6   4.495553e-19\n7  -4.221449e-19\n8   4.059275e-19\n9   3.931805e-19\n10 -3.920578e-19\n11 -3.529015e-19\n12  3.284972e-19\n13  3.264820e-19\n14 -3.239765e-19\n15  3.201897e-19\n16 -3.191032e-19\n17  3.166725e-19\n18 -3.093031e-19\n19  3.081767e-19\n20  3.035026e-19\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](family_files/figure-html/riskware-lime-shap-2.png){width=672}\n:::\n:::\n\n\n### Trojan Family Model Explanations\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Set seed for reproducibility\nset.seed(42)\n\ncategory <- \"Trojan\"\n\nif (category %in% names(category_models)) {\n  cat(sprintf(\"\\n=== %s Family Model Explanations ===\\n\", category))\n  \n  # Get the corresponding instance (same pattern as category.qmd)\n  instance_idx <- which(selected_instances_df$Category == category)\n  if (length(instance_idx) == 0) {\n    cat(sprintf(\"No instance found for category %s\\n\", category))\n  } else {\n    # Get training data for this category\n    train_family_x <- category_train_data_list[[category]]$train_x\n    model <- category_models[[category]]\n    \n    #### LIME Explanation\n    cat(sprintf(\"\\n--- LIME Explanation for %s Instance ---\\n\", category))\n    \n    # Create LIME explainer\n    explainer_family <- lime(\n      train_family_x,\n      model = model,\n      bin_continuous = TRUE,\n      n_bins = 5\n    )\n    \n    # Extract instance (same pattern as category.qmd)\n    instance_x <- as.data.frame(selected_instances_x[instance_idx, , drop = FALSE])\n    \n    lime_explanation <- lime::explain(\n      instance_x,\n      explainer = explainer_family,\n      n_features = 10,\n      n_permutations = 5000,\n      n_labels = 1\n    )\n    \n    cat(\"LIME Explanation:\\n\")\n    # Ensure explanation has proper structure for plotting\n    if (nrow(lime_explanation) > 0) {\n      # If explanation doesn't have 'case' column, add it\n      if (!\"case\" %in% colnames(lime_explanation)) {\n        lime_explanation$case <- 1\n      }\n      print(plot_features(lime_explanation))\n    } else {\n      cat(\"Warning: LIME explanation is empty. Skipping plot.\\n\")\n    }\n    \n    #### Per-Instance SHAP Values\n    cat(sprintf(\"\\n--- Per-Instance SHAP Values for %s Instance ---\\n\", category))\n    \n    # Create prediction function for fastshap\n    pred_wrapper_family <- function(object, newdata) {\n      pred <- predict(object, newdata)\n      return(pred$predictions)\n    }\n    \n    # Ensure newdata is a data.frame (same pattern as category.qmd)\n    newdata_df <- as.data.frame(selected_instances_x[instance_idx, , drop = FALSE])\n    \n    shap_instance <- explain(\n      model,\n      X = train_family_x,\n      newdata = newdata_df,\n      pred_wrapper = pred_wrapper_family,\n      nsim = 100\n    )\n    \n    # Get predicted class probabilities\n    pred_probs <- predict(model, newdata_df)$predictions\n    pred_class <- colnames(pred_probs)[which.max(pred_probs)]\n    \n    # Handle SHAP values - fastshap returns a matrix/data.frame\n    if (is.data.frame(shap_instance) || is.matrix(shap_instance)) {\n      # Check if columns are classes or features\n      if (pred_class %in% colnames(shap_instance)) {\n        shap_df <- data.frame(\n          feature = rownames(shap_instance),\n          shap_value = shap_instance[[pred_class]]\n        )\n      } else if (ncol(shap_instance) == length(feature_cols_family)) {\n        # Columns are features\n        shap_df <- data.frame(\n          feature = colnames(shap_instance),\n          shap_value = as.numeric(shap_instance[1, ])\n        )\n      } else {\n        # Try to extract first row or first column\n        if (nrow(shap_instance) == 1) {\n          shap_df <- data.frame(\n            feature = colnames(shap_instance),\n            shap_value = as.numeric(shap_instance[1, ])\n          )\n        } else {\n          shap_df <- data.frame(\n            feature = rownames(shap_instance),\n            shap_value = as.numeric(shap_instance[, 1])\n          )\n        }\n      }\n      \n      shap_df <- shap_df %>%\n        arrange(desc(abs(shap_value))) %>%\n        head(20)\n      \n      cat(sprintf(\"Top 20 SHAP values (predicted class: %s):\\n\", pred_class))\n      print(shap_df)\n      \n      # Create visualization\n      p_shap <- ggplot(shap_df, aes(x = reorder(feature, shap_value), y = shap_value)) +\n        geom_col(aes(fill = shap_value > 0)) +\n        scale_fill_manual(\n          values = c(\"TRUE\" = \"#2E8B57\", \"FALSE\" = \"#DC143C\"),\n          labels = c(\"TRUE\" = \"Positive\", \"FALSE\" = \"Negative\"),\n          name = \"SHAP Value\"\n        ) +\n        coord_flip() +\n        labs(\n          title = sprintf(\"SHAP Values - %s Instance (%s Family Model)\", category, pred_class),\n          subtitle = sprintf(\"Top 20 features by absolute SHAP value\"),\n          x = \"Feature\",\n          y = \"SHAP Value\"\n        ) +\n        theme_minimal() +\n        theme(\n          plot.title = element_text(size = 14, face = \"bold\"),\n          plot.subtitle = element_text(size = 12),\n          axis.text.y = element_text(size = 8)\n        )\n      \n      print(p_shap)\n    } else {\n      cat(sprintf(\"SHAP values format not recognized for %s instance\\n\", category))\n    }\n  }\n} else {\n  cat(sprintf(\"Model for %s not found.\\n\", category))\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== Trojan Family Model Explanations ===\n\n--- LIME Explanation for Trojan Instance ---\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Data contains numeric columns with zero variance\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Memory_OpenSSLSockets does not contain enough variance to use quantile\nbinning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Command_java.lang.Runtime_exec does not contain enough variance to\nuse quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Command_java.lang.ProcessBuilder_start does not contain enough\nvariance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_WebView_android.webkit.WebView_loadData does not contain enough\nvariance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_WebView_android.webkit.WebView_loadDataWithBaseURL does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_WebView_android.webkit.WebView_addJavascriptInterface does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_WebView_android.webkit.WebView_evaluateJavascript does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_WebView_android.webkit.WebView_postUrl does not contain enough\nvariance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_WebView_android.webkit.WebView_setWebContentsDebuggingEnabled does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_FileIO_android.content.ContextWrapper_openFileOutput does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_FileIO_android.content.ContextWrapper_deleteFile does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.content.ContextWrapper_openOrCreateDatabase does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.database.sqlite.SQLiteDatabase_execSQL does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.database.sqlite.SQLiteDatabase_insertOrThrow does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning:\nAPI_Database_android.database.sqlite.SQLiteDatabase_openOrCreateDatabase does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.database.sqlite.SQLiteDatabase_query does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.database.sqlite.SQLiteDatabase_queryWithFactory\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.database.sqlite.SQLiteDatabase_rawQuery does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_IPC_android.content.ContextWrapper_sendBroadcast does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_IPC_android.content.ContextWrapper_startActivity does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.telephony.TelephonyManager_getLine1Number does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.telephony.TelephonyManager_getNetworkOperator\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning:\nAPI_DeviceInfo_android.telephony.TelephonyManager_getNetworkOperatorName does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.telephony.TelephonyManager_getSimOperatorName\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.net.wifi.WifiInfo_getBSSID does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.net.wifi.WifiInfo_getIpAddress does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.net.wifi.WifiInfo_getNetworkId does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.telephony.TelephonyManager_getSimCountryIso\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.telephony.TelephonyManager_getSimSerialNumber\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning:\nAPI_DeviceInfo_android.telephony.TelephonyManager_getDeviceSoftwareVersion does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.os.Debug_isDebuggerConnected does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning:\nAPI_Network_com.android.okhttp.internal.huc.HttpURLConnectionImpl_getInputStream\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DexClassLoader_dalvik.system.BaseDexClassLoader_findResources does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DexClassLoader_dalvik.system.DexClassLoader_$init does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Base64_android.util.Base64_decode does not contain enough variance\nto use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Base64_android.util.Base64_encode does not contain enough variance\nto use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Base64_android.util.Base64_encodeToString does not contain enough\nvariance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning:\nAPI_SystemManager_android.app.ApplicationPackageManager_setComponentEnabledSetting\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_SystemManager_android.app.NotificationManager_notify does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_SystemManager_android.telephony.TelephonyManager_listen does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_SystemManager_android.content.BroadcastReceiver_abortBroadcast\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_SMS_android.telephony.SmsManager_sendTextMessage does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_SMS_android.telephony.SmsManager_sendMultipartTextMessage does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.accounts.AccountManager_getAccountsByType does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.accounts.AccountManager_getAccounts does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.media.AudioRecord_startRecording does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.media.MediaRecorder_start does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning:\nAPI_DeviceData_android.app.ApplicationPackageManager_getInstalledPackages does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: base64_calls does not contain enough variance to use quantile binning.\nUsing standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: log_base64 does not contain enough variance to use quantile binning.\nUsing standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: mic_calls does not contain enough variance to use quantile binning.\nUsing standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLIME Explanation:\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](family_files/figure-html/trojan-lime-shap-1.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n--- Per-Instance SHAP Values for Trojan Instance ---\nTop 20 SHAP values (predicted class: smsagent):\n                                                                   feature\n1                API_Database_android.database.sqlite.SQLiteDatabase_query\n2                                                                env_calls\n3                           API_DeviceData_android.os.SystemProperties_get\n4                                            Network_TotalTransmittedBytes\n5  API_Database_android.database.sqlite.SQLiteDatabase_rawQueryWithFactory\n6                                                              dirty_ratio\n7   API_DeviceData_android.content.ContentResolver_registerContentObserver\n8                                                      Memory_ParcelMemory\n9                                          Network_TotalTransmittedPackets\n10                                                         env_probe_count\n11                                                           log_env_probe\n12                                                     Memory_PrivateClean\n13                                                         Memory_HeapFree\n14                                                      Memory_SharedDirty\n15                                                           log_DB_writes\n16            API_Database_android.database.sqlite.SQLiteDatabase_rawQuery\n17                                                             Logcat_info\n18                                                        Battery_wakelock\n19                                            Network_TotalReceivedPackets\n20                                                                 has_ids\n      shap_value\n1  -3.183518e-19\n2  -2.562930e-19\n3  -2.465187e-19\n4  -2.287947e-19\n5   2.266434e-19\n6  -2.055528e-19\n7  -2.029071e-19\n8  -1.969986e-19\n9  -1.945827e-19\n10 -1.768350e-19\n11  1.670087e-19\n12  1.565593e-19\n13 -1.541926e-19\n14  1.488228e-19\n15 -1.477685e-19\n16  1.321558e-19\n17 -1.278208e-19\n18 -1.240212e-19\n19 -1.170401e-19\n20  1.158144e-19\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](family_files/figure-html/trojan-lime-shap-2.png){width=672}\n:::\n:::\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}