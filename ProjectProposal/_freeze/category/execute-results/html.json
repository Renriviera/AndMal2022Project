{
  "hash": "8873c0f526fea1096d23c3809c921bcd",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Category Prediction Model\"\nformat: html\n---\n\nThis document trains and evaluates a random forest model to predict the malware category using features from the AndMal2020 dataset.\n\n## Load Libraries and Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ranger)\nlibrary(dplyr)\nlibrary(caret)\nlibrary(parallel)\nlibrary(lime)\nlibrary(fastshap)\nlibrary(ggplot2)\nlibrary(stringr)\nlibrary(kableExtra)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'kableExtra'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following object is masked from 'package:dplyr':\n\n    group_rows\n```\n\n\n:::\n\n```{.r .cell-code}\n# Configuration\nnum_threads <- 8L\nnum_trees <- 500L\ntrain_test_split <- 0.8\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load preprocessed data (from preprocessing.qmd)\nandmal_after <- readRDS(\"data/processed/andmal_after.rds\")\n\ncat(sprintf(\"Loaded dataset: %d rows, %d columns\\n\", nrow(andmal_after), ncol(andmal_after)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLoaded dataset: 25059 rows, 185 columns\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Category distribution:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCategory distribution:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(table(andmal_after$Category))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n        Adware       Backdoor   FileInfector    No_Category            PUA \n          5142            546            119            884            625 \n    Ransomware       Riskware      Scareware         Trojan  Trojan_Banker \n          1550           6792            424           4025            123 \nTrojan_Dropper     Trojan_SMS     Trojan_Spy       Zero_Day \n           733            911           1039           2146 \n```\n\n\n:::\n:::\n\n\n## Feature Selection\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Metadata columns to exclude from features\nmetadata_cols <- c(\"Category\", \"Family\", \"Category_file\", \"reboot_state\", \"path\", \"file\", \"Hash\")\n\n# Get all column names\nall_cols <- names(andmal_after)\n\n# Identify metadata columns that actually exist\nmetadata_cols_present <- intersect(metadata_cols, all_cols)\n\n# Feature columns for Category prediction (exclude Family and Category, plus other metadata)\nfeature_cols_model1 <- setdiff(all_cols, metadata_cols_present)\n\n# Additional exclusion: any rank/color columns that might have been added\nfeature_cols_model1 <- feature_cols_model1[!str_detect(feature_cols_model1, \"rank|color|fam_color|rank_in_cat\")]\n\ncat(sprintf(\"Model features (Category prediction): %d features\\n\", length(feature_cols_model1)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nModel features (Category prediction): 178 features\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(sprintf(\"Excluded metadata columns: %s\\n\", paste(metadata_cols_present, collapse = \", \")))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nExcluded metadata columns: Category, Family, Category_file, reboot_state, path, file, Hash\n```\n\n\n:::\n:::\n\n\n## Train/Test Split\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create stratified split for Category\nset.seed(42)\ncaret_available <- require(\"caret\", quietly = TRUE)\n\nif (caret_available) {\n  train_index <- caret::createDataPartition(\n    andmal_after$Category,\n    p = train_test_split,\n    list = FALSE,\n    times = 1\n  )\n  train_data <- andmal_after[train_index, ]\n  test_data <- andmal_after[-train_index, ]\n} else {\n  # Use base R stratified sampling\n  categories <- unique(andmal_after$Category)\n  train_indices <- c()\n  for (cat in categories) {\n    cat_indices <- which(andmal_after$Category == cat)\n    n_train <- round(length(cat_indices) * train_test_split)\n    train_cat_indices <- sample(cat_indices, n_train)\n    train_indices <- c(train_indices, train_cat_indices)\n  }\n  train_data <- andmal_after[train_indices, ]\n  test_data <- andmal_after[-train_indices, ]\n}\n\ncat(sprintf(\"Training set: %d rows (%.1f%%)\\n\", nrow(train_data), 100 * nrow(train_data) / nrow(andmal_after)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTraining set: 20053 rows (80.0%)\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(sprintf(\"Test set: %d rows (%.1f%%)\\n\", nrow(test_data), 100 * nrow(test_data) / nrow(andmal_after)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTest set: 5006 rows (20.0%)\n```\n\n\n:::\n:::\n\n\n## Train Model\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Prepare data\ntrain_model1_x <- train_data[, feature_cols_model1, drop = FALSE]\ntrain_model1_y <- train_data$Category\ntest_model1_x <- test_data[, feature_cols_model1, drop = FALSE]\ntest_model1_y <- test_data$Category\n\n# Calculate mtry (default: sqrt of number of features)\nmtry_model1 <- floor(sqrt(length(feature_cols_model1)))\n\ncat(sprintf(\"Model parameters:\\n\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nModel parameters:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(sprintf(\"  Number of trees: %d\\n\", num_trees))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Number of trees: 500\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(sprintf(\"  mtry: %d (sqrt of %d features)\\n\", mtry_model1, length(feature_cols_model1)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  mtry: 13 (sqrt of 178 features)\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(sprintf(\"  Number of threads: %d\\n\", num_threads))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Number of threads: 8\n```\n\n\n:::\n\n```{.r .cell-code}\n# Train model\ncat(\"Training random forest for Category prediction...\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTraining random forest for Category prediction...\n```\n\n\n:::\n\n```{.r .cell-code}\nstart_time <- Sys.time()\n\nrf_category <- ranger(\n  x = train_model1_x,\n  y = train_model1_y,\n  num.trees = num_trees,\n  mtry = mtry_model1,\n  min.node.size = 1,\n  num.threads = num_threads,\n  classification = TRUE,\n  probability = TRUE,\n  importance = \"impurity\",\n  verbose = TRUE\n)\n\nend_time <- Sys.time()\ntraining_time <- difftime(end_time, start_time, units = \"mins\")\ncat(sprintf(\"Training completed in %.2f minutes\\n\", as.numeric(training_time)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTraining completed in 0.23 minutes\n```\n\n\n:::\n:::\n\n\n## Evaluate Model\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(\"Evaluating model...\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nEvaluating model...\n```\n\n\n:::\n\n```{.r .cell-code}\npred_model1 <- predict(rf_category, test_model1_x)\npred_categories <- pred_model1$predictions\n\n# Get predicted class (highest probability)\npred_categories_class <- colnames(pred_categories)[apply(pred_categories, 1, which.max)]\npred_categories_class <- factor(pred_categories_class, levels = levels(test_model1_y))\n\n# Confusion matrix (always use caret)\ncm_model1 <- caret::confusionMatrix(pred_categories_class, test_model1_y)\n\n# Calculate per-class metrics\nmetrics_model1 <- cm_model1$overall\nper_class_model1 <- cm_model1$byClass\n\ncat(\"\\nOverall Accuracy:\", metrics_model1[\"Accuracy\"], \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nOverall Accuracy: 0.801638 \n```\n\n\n:::\n:::\n\n\n### Model Performance Metrics\n\n\n::: {.cell}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-condensed\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Category Prediction Model Performance Metrics</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;font-weight: bold;color: white !important;background-color: rgba(68, 114, 196, 255) !important;\"> Category </th>\n   <th style=\"text-align:center;font-weight: bold;color: white !important;background-color: rgba(68, 114, 196, 255) !important;\"> Overall Accuracy </th>\n   <th style=\"text-align:center;font-weight: bold;color: white !important;background-color: rgba(68, 114, 196, 255) !important;\"> Precision </th>\n   <th style=\"text-align:center;font-weight: bold;color: white !important;background-color: rgba(68, 114, 196, 255) !important;\"> Recall </th>\n   <th style=\"text-align:center;font-weight: bold;color: white !important;background-color: rgba(68, 114, 196, 255) !important;\"> F1 Score </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Class: Adware </td>\n   <td style=\"text-align:center;\"> 0.8016 </td>\n   <td style=\"text-align:center;\"> 0.7094 </td>\n   <td style=\"text-align:center;\"> 0.9261 </td>\n   <td style=\"text-align:center;\"> 0.8034 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Class: Backdoor </td>\n   <td style=\"text-align:center;\"> 0.8016 </td>\n   <td style=\"text-align:center;\"> 0.8816 </td>\n   <td style=\"text-align:center;\"> 0.6147 </td>\n   <td style=\"text-align:center;\"> 0.7243 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Class: FileInfector </td>\n   <td style=\"text-align:center;\"> 0.8016 </td>\n   <td style=\"text-align:center;\"> 0.6875 </td>\n   <td style=\"text-align:center;\"> 0.4783 </td>\n   <td style=\"text-align:center;\"> 0.5641 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Class: No_Category </td>\n   <td style=\"text-align:center;\"> 0.8016 </td>\n   <td style=\"text-align:center;\"> 0.7959 </td>\n   <td style=\"text-align:center;\"> 0.2216 </td>\n   <td style=\"text-align:center;\"> 0.3467 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Class: PUA </td>\n   <td style=\"text-align:center;\"> 0.8016 </td>\n   <td style=\"text-align:center;\"> 0.9362 </td>\n   <td style=\"text-align:center;\"> 0.7040 </td>\n   <td style=\"text-align:center;\"> 0.8037 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Class: Ransomware </td>\n   <td style=\"text-align:center;\"> 0.8016 </td>\n   <td style=\"text-align:center;\"> 0.7557 </td>\n   <td style=\"text-align:center;\"> 0.8484 </td>\n   <td style=\"text-align:center;\"> 0.7994 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Class: Riskware </td>\n   <td style=\"text-align:center;\"> 0.8016 </td>\n   <td style=\"text-align:center;\"> 0.8772 </td>\n   <td style=\"text-align:center;\"> 0.8888 </td>\n   <td style=\"text-align:center;\"> 0.8830 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Class: Scareware </td>\n   <td style=\"text-align:center;\"> 0.8016 </td>\n   <td style=\"text-align:center;\"> 0.8519 </td>\n   <td style=\"text-align:center;\"> 0.8214 </td>\n   <td style=\"text-align:center;\"> 0.8364 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Class: Trojan </td>\n   <td style=\"text-align:center;\"> 0.8016 </td>\n   <td style=\"text-align:center;\"> 0.8552 </td>\n   <td style=\"text-align:center;\"> 0.8584 </td>\n   <td style=\"text-align:center;\"> 0.8568 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Class: Trojan_Banker </td>\n   <td style=\"text-align:center;\"> 0.8016 </td>\n   <td style=\"text-align:center;\"> 0.7778 </td>\n   <td style=\"text-align:center;\"> 0.5833 </td>\n   <td style=\"text-align:center;\"> 0.6667 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Class: Trojan_Dropper </td>\n   <td style=\"text-align:center;\"> 0.8016 </td>\n   <td style=\"text-align:center;\"> 0.8113 </td>\n   <td style=\"text-align:center;\"> 0.5890 </td>\n   <td style=\"text-align:center;\"> 0.6825 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Class: Trojan_SMS </td>\n   <td style=\"text-align:center;\"> 0.8016 </td>\n   <td style=\"text-align:center;\"> 0.8025 </td>\n   <td style=\"text-align:center;\"> 0.6923 </td>\n   <td style=\"text-align:center;\"> 0.7434 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Class: Trojan_Spy </td>\n   <td style=\"text-align:center;\"> 0.8016 </td>\n   <td style=\"text-align:center;\"> 0.9146 </td>\n   <td style=\"text-align:center;\"> 0.8792 </td>\n   <td style=\"text-align:center;\"> 0.8966 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Class: Zero_Day </td>\n   <td style=\"text-align:center;\"> 0.8016 </td>\n   <td style=\"text-align:center;\"> 0.6488 </td>\n   <td style=\"text-align:center;\"> 0.5082 </td>\n   <td style=\"text-align:center;\"> 0.5699 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n### Performance Metrics\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\nOverall Metrics:\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      Accuracy          Kappa  AccuracyLower  AccuracyUpper   AccuracyNull \n     0.8016380      0.7608723      0.7903172      0.8126060      0.2712745 \nAccuracyPValue  McnemarPValue \n     0.0000000            NaN \n\nPer-Class Metrics:\n                      Sensitivity Specificity Pos Pred Value Neg Pred Value\nClass: Adware           0.9260700   0.9019608      0.7093890      0.9792576\nClass: Backdoor         0.6146789   0.9981621      0.8815789      0.9914807\nClass: FileInfector     0.4782609   0.9989966      0.6875000      0.9975952\nClass: No_Category      0.2215909   0.9979296      0.7959184      0.9723623\nClass: PUA              0.7040000   0.9987707      0.9361702      0.9924674\nClass: Ransomware       0.8483871   0.9818995      0.7557471      0.9899098\nClass: Riskware         0.8888071   0.9536732      0.8771802      0.9584022\nClass: Scareware        0.8214286   0.9975620      0.8518519      0.9969543\nClass: Trojan           0.8583851   0.9721495      0.8551980      0.9728442\nClass: Trojan_Banker    0.5833333   0.9991971      0.7777778      0.9979952\nClass: Trojan_Dropper   0.5890411   0.9958848      0.8113208      0.9877551\nClass: Trojan_SMS       0.6923077   0.9935738      0.8025478      0.9884512\nClass: Trojan_Spy       0.8792271   0.9964576      0.9145729      0.9947993\nClass: Zero_Day         0.5081585   0.9742189      0.6488095      0.9548180\n                      Precision    Recall        F1  Prevalence Detection Rate\nClass: Adware         0.7093890 0.9260700 0.8033755 0.205353576    0.190171794\nClass: Backdoor       0.8815789 0.6146789 0.7243243 0.021773871    0.013383939\nClass: FileInfector   0.6875000 0.4782609 0.5641026 0.004594487    0.002197363\nClass: No_Category    0.7959184 0.2215909 0.3466667 0.035157811    0.007790651\nClass: PUA            0.9361702 0.7040000 0.8036530 0.024970036    0.017578905\nClass: Ransomware     0.7557471 0.8483871 0.7993921 0.061925689    0.052536956\nClass: Riskware       0.8771802 0.8888071 0.8829554 0.271274471    0.241110667\nClass: Scareware      0.8518519 0.8214286 0.8363636 0.016779864    0.013783460\nClass: Trojan         0.8551980 0.8583851 0.8567886 0.160807032    0.138034359\nClass: Trojan_Banker  0.7777778 0.5833333 0.6666667 0.004794247    0.002796644\nClass: Trojan_Dropper 0.8113208 0.5890411 0.6825397 0.029165002    0.017179385\nClass: Trojan_SMS     0.8025478 0.6923077 0.7433628 0.036356372    0.025169796\nClass: Trojan_Spy     0.9145729 0.8792271 0.8965517 0.041350380    0.036356372\nClass: Zero_Day       0.6488095 0.5081585 0.5699346 0.085697163    0.043547743\n                      Detection Prevalence Balanced Accuracy\nClass: Adware                  0.268078306         0.9140154\nClass: Backdoor                0.015181782         0.8064205\nClass: FileInfector            0.003196165         0.7386287\nClass: No_Category             0.009788254         0.6097603\nClass: PUA                     0.018777467         0.8513854\nClass: Ransomware              0.069516580         0.9151433\nClass: Riskware                0.274870156         0.9212402\nClass: Scareware               0.016180583         0.9094953\nClass: Trojan                  0.161406312         0.9152673\nClass: Trojan_Banker           0.003595685         0.7912652\nClass: Trojan_Dropper          0.021174590         0.7924629\nClass: Trojan_SMS              0.031362365         0.8429407\nClass: Trojan_Spy              0.039752297         0.9378423\nClass: Zero_Day                0.067119457         0.7411887\n```\n\n\n:::\n:::\n\n\n### Feature Importance\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\nTop 20 Most Important Features:\n                                                             feature importance\n1                                                 Memory_SharedClean   286.0151\n2                                                   Memory_HeapAlloc   277.3746\n3                                                Memory_PrivateDirty   270.2006\n4                                                    Memory_HeapSize   265.4737\n5                                                 Memory_SharedDirty   253.5467\n6                                                          env_calls   238.2461\n7                                                           id_calls   235.6163\n8                                                    env_probe_count   234.1417\n9      API_DeviceInfo_android.telephony.TelephonyManager_getDeviceId   229.4430\n10 API_DeviceInfo_android.telephony.TelephonyManager_getSubscriberId   228.9477\n11                                                     log_env_probe   227.1079\n12                                                       shared_frac   222.1061\n13                                                       dirty_ratio   221.3345\n14                                               Memory_PrivateClean   220.5567\n15                                                   Memory_PssTotal   218.5991\n16                                                    accounts_calls   216.5292\n17                     API_Binder_android.app.Activity_startActivity   216.0924\n18                        API_Command_java.lang.ProcessBuilder_start   215.9785\n19                                                   Memory_PssClean   215.7622\n20                                                      log_PssTotal   215.7415\n```\n\n\n:::\n:::\n\n\n## Save Model\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsaveRDS(rf_category, \"data/models/rf_category_model.rds\")\ncat(\"Saved: data/models/rf_category_model.rds\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSaved: data/models/rf_category_model.rds\n```\n\n\n:::\n:::\n\n\n## Random Forest Model Summary\n\nThe random forest model for category prediction demonstrates strong performance in distinguishing between malware categories. The model utilizes a comprehensive set of behavioral features extracted from dynamic analysis to classify samples into their respective categories. The ensemble approach of random forests allows the model to capture complex interactions between features while maintaining interpretability through feature importance measures.\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\nModel Configuration:\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Number of trees: 500\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Number of features: 178\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  mtry parameter: 13\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Training accuracy: 0.7771\n```\n\n\n:::\n:::\n\n\n## Model Interpretability\n\n### Instance Selection\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Set seed for reproducibility\nset.seed(42)\n\n# Select one instance from each category from the test set\ntarget_categories <- c(\"Adware\", \"Riskware\", \"Trojan\")\nselected_instances <- list()\n\nfor (category in target_categories) {\n  category_indices <- which(test_data$Category == category)\n  if (length(category_indices) > 0) {\n    # Select first instance from this category in test set\n    selected_idx <- category_indices[1]\n    selected_instances[[category]] <- test_data[selected_idx, ]\n    cat(sprintf(\"Selected %s instance: row %d\\n\", category, selected_idx))\n  } else {\n    cat(sprintf(\"WARNING: No %s instances found in test set\\n\", category))\n  }\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSelected Adware instance: row 1\nSelected Riskware instance: row 1772\nSelected Trojan instance: row 3214\n```\n\n\n:::\n\n```{.r .cell-code}\n# Combine into a single data frame for easier handling\nselected_instances_df <- bind_rows(selected_instances)\n\n# Extract feature matrices for explanations\nselected_instances_x <- selected_instances_df[, feature_cols_model1, drop = FALSE]\n\n# Save selected instances for use in family.qmd\nif (!dir.exists(\"data/processed\")) {\n  dir.create(\"data/processed\", recursive = TRUE)\n}\nsaveRDS(selected_instances_df, \"data/processed/selected_instances.rds\")\ncat(\"\\nSaved selected instances to data/processed/selected_instances.rds\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nSaved selected instances to data/processed/selected_instances.rds\n```\n\n\n:::\n:::\n\n\n### LIME Explanations\n\nLIME (Local Interpretable Model-agnostic Explanations) generates local approximations of the model's behavior. These explanations highlight the most influential features for each prediction by creating simplified, interpretable models that approximate the complex random forest in the vicinity of each instance. This approach allows us to understand the decision-making process at the individual sample level, revealing which behavioral features are most critical for distinguishing between malware categories.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Set seed for reproducibility\nset.seed(42)\n\n# Create a prediction function wrapper for ranger model\npredict_function <- function(model, newdata) {\n  pred <- predict(model, newdata)\n  return(pred$predictions)\n}\n\n# Create LIME explainer\ncat(\"Creating LIME explainer...\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCreating LIME explainer...\n```\n\n\n:::\n\n```{.r .cell-code}\nexplainer <- lime(\n  train_model1_x,\n  model = rf_category,\n  bin_continuous = TRUE,\n  n_bins = 5\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Data contains numeric columns with zero variance\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Memory_OpenSSLSockets does not contain enough variance to use quantile\nbinning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Process_android.app.ActivityManager_killBackgroundProcesses does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_JavaNativeInterface_java.lang.Runtime_load does not contain enough\nvariance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_WebView_android.webkit.WebView_loadData does not contain enough\nvariance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_WebView_android.webkit.WebView_loadDataWithBaseURL does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_WebView_android.webkit.WebView_addJavascriptInterface does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_WebView_android.webkit.WebView_evaluateJavascript does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_WebView_android.webkit.WebView_postUrl does not contain enough\nvariance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_WebView_android.webkit.WebView_setWebContentsDebuggingEnabled does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_FileIO_android.content.ContextWrapper_openFileOutput does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.content.ContextWrapper_openOrCreateDatabase does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.content.ContextWrapper_databaseList does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.content.ContextWrapper_deleteDatabase does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.database.sqlite.SQLiteDatabase_execSQL does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.database.sqlite.SQLiteDatabase_deleteDatabase\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.database.sqlite.SQLiteDatabase_insert does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.database.sqlite.SQLiteDatabase_insertOrThrow does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning:\nAPI_Database_android.database.sqlite.SQLiteDatabase_insertWithOnConflict does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning:\nAPI_Database_android.database.sqlite.SQLiteDatabase_openOrCreateDatabase does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.database.sqlite.SQLiteDatabase_query does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.database.sqlite.SQLiteDatabase_queryWithFactory\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Database_android.database.sqlite.SQLiteDatabase_update does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning:\nAPI_Database_android.database.sqlite.SQLiteDatabase_updateWithOnConflict does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_IPC_android.content.ContextWrapper_sendStickyBroadcast does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_IPC_android.content.ContextWrapper_startActivity does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_IPC_android.content.ContextWrapper_stopService does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.telephony.TelephonyManager_getLine1Number does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.telephony.TelephonyManager_getNetworkOperator\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.telephony.TelephonyManager_getSimOperatorName\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.net.wifi.WifiInfo_getBSSID does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.net.wifi.WifiInfo_getIpAddress does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.net.wifi.WifiInfo_getNetworkId does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.telephony.TelephonyManager_getSimCountryIso\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.telephony.TelephonyManager_getSimSerialNumber\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning:\nAPI_DeviceInfo_android.telephony.TelephonyManager_getDeviceSoftwareVersion does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceInfo_android.os.Debug_isDebuggerConnected does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DexClassLoader_dalvik.system.BaseDexClassLoader_findResources does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DexClassLoader_dalvik.system.DexFile_loadDex does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DexClassLoader_dalvik.system.DexFile_loadClass does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_Base64_android.util.Base64_decode does not contain enough variance\nto use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning:\nAPI_SystemManager_android.app.ApplicationPackageManager_setComponentEnabledSetting\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_SystemManager_android.app.NotificationManager_notify does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_SystemManager_android.telephony.TelephonyManager_listen does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_SystemManager_android.content.BroadcastReceiver_abortBroadcast\ndoes not contain enough variance to use quantile binning. Using standard\nbinning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_SMS_android.telephony.SmsManager_sendTextMessage does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_SMS_android.telephony.SmsManager_sendMultipartTextMessage does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.content.ContentResolver_insert does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.content.ContentResolver_delete does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.accounts.AccountManager_getAccountsByType does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.accounts.AccountManager_getAccounts does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.location.Location_getLatitude does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.location.Location_getLongitude does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.media.AudioRecord_startRecording does not\ncontain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: API_DeviceData_android.media.MediaRecorder_start does not contain\nenough variance to use quantile binning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning:\nAPI_DeviceData_android.app.ApplicationPackageManager_getInstalledPackages does\nnot contain enough variance to use quantile binning. Using standard binning\ninstead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: location_calls does not contain enough variance to use quantile\nbinning. Using standard binning instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: mic_calls does not contain enough variance to use quantile binning.\nUsing standard binning instead.\n```\n\n\n:::\n\n```{.r .cell-code}\n# Generate explanations for all selected instances\ncat(\"Generating LIME explanations for selected instances...\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nGenerating LIME explanations for selected instances...\n```\n\n\n:::\n\n```{.r .cell-code}\nlime_explanations <- lime::explain(\n  selected_instances_x,\n  explainer = explainer,\n  n_features = 10,\n  n_permutations = 5000,\n  n_labels = 1\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\nWarning in gower_work(x = x, y = y, pair_x = pair_x, pair_y = pair_y, n = NULL,\n: skipping variable with zero or non-finite range.\n```\n\n\n:::\n\n```{.r .cell-code}\n# Plot LIME explanations\ncat(\"Plotting LIME explanations...\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPlotting LIME explanations...\n```\n\n\n:::\n\n```{.r .cell-code}\nfor (i in 1:nrow(selected_instances_x)) {\n  category_name <- selected_instances_df$Category[i]\n  cat(sprintf(\"\\nLIME Explanation for %s instance:\\n\", category_name))\n  print(plot_features(lime_explanations[lime_explanations$case == i, ]))\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nLIME Explanation for Adware instance:\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: `aes_()` was deprecated in ggplot2 3.0.0.\nℹ Please use tidy evaluation idioms with `aes()`\nℹ The deprecated feature was likely used in the lime package.\n  Please report the issue at <https://github.com/thomasp85/lime/issues>.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](category_files/figure-html/lime-explanations-1.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nLIME Explanation for Riskware instance:\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](category_files/figure-html/lime-explanations-2.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nLIME Explanation for Trojan instance:\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](category_files/figure-html/lime-explanations-3.png){width=672}\n:::\n:::\n\n\n### fastshap Explanations\n\nSHAP (SHapley Additive exPlanations) values provide insight into feature contributions for individual predictions. The analysis reveals which features drive classification decisions for each category instance. By decomposing the model's output into additive feature contributions, SHAP values offer a unified framework for understanding how each feature influences the final prediction, making it possible to explain why a particular sample was classified into a specific category.\n\n#### Per-Instance SHAP Values\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Set seed for reproducibility\nset.seed(42)\n\n# Create prediction function for fastshap\npred_wrapper <- function(object, newdata) {\n  pred <- predict(object, newdata)\n  return(pred$predictions)\n}\n\ncat(\"Calculating SHAP values for selected instances...\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCalculating SHAP values for selected instances...\n```\n\n\n:::\n\n```{.r .cell-code}\n# Calculate SHAP values for each selected instance\nshap_values_list <- list()\n\nfor (i in 1:nrow(selected_instances_x)) {\n  category_name <- selected_instances_df$Category[i]\n  cat(sprintf(\"Calculating SHAP values for %s instance...\\n\", category_name))\n  \n  # Ensure newdata is a data.frame to match training feature class\n  newdata_df <- as.data.frame(selected_instances_x[i, , drop = FALSE])\n  \n  # Calculate SHAP values for this instance\n  shap_vals <- explain(\n    rf_category,\n    X = train_model1_x,\n    newdata = newdata_df,\n    pred_wrapper = pred_wrapper,\n    nsim = 100\n  )\n  \n  shap_values_list[[category_name]] <- shap_vals\n  \n  # Plot SHAP values for this instance\n  # Get the predicted class probabilities\n  pred_probs <- predict(rf_category, newdata_df)$predictions\n  pred_class <- colnames(pred_probs)[which.max(pred_probs)]\n  \n  # Handle SHAP values - fastshap returns a matrix/data.frame\n  # For multi-class, extract SHAP values for the predicted class\n  if (is.data.frame(shap_vals) || is.matrix(shap_vals)) {\n    # If it's a matrix/data.frame, check if it has class columns\n    if (pred_class %in% colnames(shap_vals)) {\n      shap_df <- data.frame(\n        feature = rownames(shap_vals),\n        shap_value = shap_vals[[pred_class]]\n      )\n    } else if (ncol(shap_vals) == length(feature_cols_model1)) {\n      # If columns are features, use the first (or only) row\n      shap_df <- data.frame(\n        feature = colnames(shap_vals),\n        shap_value = as.numeric(shap_vals[1, ])\n      )\n    } else {\n      # Try to extract first column or first row\n      if (nrow(shap_vals) == 1) {\n        shap_df <- data.frame(\n          feature = colnames(shap_vals),\n          shap_value = as.numeric(shap_vals[1, ])\n        )\n      } else {\n        shap_df <- data.frame(\n          feature = rownames(shap_vals),\n          shap_value = as.numeric(shap_vals[, 1])\n        )\n      }\n    }\n    \n    shap_df <- shap_df %>%\n      arrange(desc(abs(shap_value))) %>%\n      head(20)\n    \n    cat(sprintf(\"\\nTop 20 SHAP values for %s instance (predicted class: %s):\\n\", \n                category_name, pred_class))\n    print(shap_df)\n    \n    # Create visualization\n    p_shap <- ggplot(shap_df, aes(x = reorder(feature, shap_value), y = shap_value)) +\n      geom_col(aes(fill = shap_value > 0)) +\n      scale_fill_manual(\n        values = c(\"TRUE\" = \"#2E8B57\", \"FALSE\" = \"#DC143C\"),\n        labels = c(\"TRUE\" = \"Positive\", \"FALSE\" = \"Negative\"),\n        name = \"SHAP Value\"\n      ) +\n      coord_flip() +\n      labs(\n        title = sprintf(\"SHAP Values - %s Instance\", category_name),\n        subtitle = sprintf(\"Predicted class: %s\", pred_class),\n        x = \"Feature\",\n        y = \"SHAP Value\"\n      ) +\n      theme_minimal() +\n      theme(\n        plot.title = element_text(size = 14, face = \"bold\"),\n        plot.subtitle = element_text(size = 12),\n        axis.text.y = element_text(size = 8)\n      )\n    \n    print(p_shap)\n  } else {\n    cat(sprintf(\"SHAP values format not recognized for %s instance\\n\", category_name))\n  }\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCalculating SHAP values for Adware instance...\n\nTop 20 SHAP values for Adware instance (predicted class: Adware):\n                                                                  feature\n1                                           Network_TotalTransmittedBytes\n2                                                        Memory_HeapAlloc\n3                    API_Binder_android.app.ActivityThread_handleReceiver\n4                    API_DeviceData_android.content.ContentResolver_query\n5                     API_IPC_android.content.ContextWrapper_startService\n6                    API_IPC_android.content.ContextWrapper_sendBroadcast\n7                                                     Memory_ProxyBinders\n8                                                      Memory_SharedClean\n9                                                                id_calls\n10                                  API_Base64_android.util.Base64_encode\n11                                                    Memory_ViewRootImpl\n12                                                         log_PII_access\n13                                                          API__sessions\n14                                                       log_Logcat_total\n15                                                    Memory_LocalBinders\n16 API_DeviceData_android.content.ContentResolver_registerContentObserver\n17                                                        Memory_HeapSize\n18                                                           log_PssTotal\n19                                                    Memory_PrivateDirty\n20                                                        Battery_service\n      shap_value\n1   8.617211e-19\n2  -7.793768e-19\n3  -6.954473e-19\n4  -5.848039e-19\n5  -5.355656e-19\n6   5.228710e-19\n7   5.082034e-19\n8   4.750366e-19\n9  -4.251346e-19\n10 -4.100540e-19\n11 -3.856626e-19\n12 -3.754009e-19\n13  3.713274e-19\n14  3.710400e-19\n15 -3.628629e-19\n16 -3.507530e-19\n17 -3.473351e-19\n18  3.338693e-19\n19 -3.320157e-19\n20  2.987591e-19\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](category_files/figure-html/shap-per-instance-1.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCalculating SHAP values for Riskware instance...\n\nTop 20 SHAP values for Riskware instance (predicted class: Riskware):\n                                                                            feature\n1                                API_Crypto-Hash_java.security.MessageDigest_update\n2                                                     Network_TotalTransmittedBytes\n3                                                               Memory_LocalBinders\n4                                                                   Memory_HeapSize\n5                                                                         env_calls\n6                                                                      Logcat_debug\n7                                                                      has_receiver\n8  API_Network_com.android.okhttp.internal.huc.HttpURLConnectionImpl_getInputStream\n9                                                   Network_TotalTransmittedPackets\n10                                          API_Network_java.net.URL_openConnection\n11                                                               Memory_SharedClean\n12                                                                   log_PII_access\n13                                                               Memory_SharedDirty\n14                                                     Network_TotalReceivedPackets\n15             API_Database_android.database.sqlite.SQLiteDatabase_compileStatement\n16                        API_Database_android.database.sqlite.SQLiteDatabase_query\n17                                                                     Logcat_total\n18                     API_Database_android.database.sqlite.SQLiteDatabase_rawQuery\n19                                                                  Memory_WebViews\n20                                                                 Memory_HeapAlloc\n      shap_value\n1   7.846069e-19\n2  -5.519818e-19\n3  -4.568190e-19\n4  -4.268638e-19\n5   4.140249e-19\n6   3.952104e-19\n7   3.633626e-19\n8   3.622010e-19\n9   3.557091e-19\n10  3.486363e-19\n11  3.380678e-19\n12  2.828092e-19\n13  2.646064e-19\n14  2.619365e-19\n15  2.401228e-19\n16 -2.345725e-19\n17  2.275038e-19\n18  2.252831e-19\n19  2.187730e-19\n20 -2.079720e-19\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](category_files/figure-html/shap-per-instance-2.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCalculating SHAP values for Trojan instance...\n\nTop 20 SHAP values for Trojan instance (predicted class: Trojan):\n                                                                              feature\n1            API_Database_android.database.sqlite.SQLiteDatabase_insertWithOnConflict\n2                                                                  Memory_SharedClean\n3                                                                    Battery_wakelock\n4                                                 API_FileIO_libcore.io.IoBridge_open\n5                                                                        Logcat_total\n6                                                                        crypto_calls\n7                                                          Network_TotalReceivedBytes\n8                                                                    log_API_sessions\n9            API_DeviceInfo_android.telephony.TelephonyManager_getNetworkOperatorName\n10                                            API_Network_java.net.URL_openConnection\n11                                                                Memory_ParcelMemory\n12 API_SystemManager_android.app.ApplicationPackageManager_setComponentEnabledSetting\n13                                                                 Memory_SharedDirty\n14                                                                            has_ids\n15                                                                Memory_ViewRootImpl\n16                                                                           id_calls\n17                                                                     log_NetRxBytes\n18                                      API_Binder_android.app.Activity_startActivity\n19                                                                      log_DB_writes\n20                                                                     log_NetTxBytes\n      shap_value\n1   5.108292e-19\n2   4.198917e-19\n3   4.010086e-19\n4   3.746418e-19\n5   3.721028e-19\n6  -3.642544e-19\n7   3.557764e-19\n8  -3.520656e-19\n9   3.511073e-19\n10  3.451922e-19\n11  3.129409e-19\n12  2.919777e-19\n13 -2.764604e-19\n14  2.678138e-19\n15  2.577757e-19\n16 -2.552612e-19\n17  2.510519e-19\n18  2.383430e-19\n19  2.343449e-19\n20  2.327453e-19\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](category_files/figure-html/shap-per-instance-3.png){width=672}\n:::\n\n```{.r .cell-code}\ncat(\"\\nPer-instance SHAP calculations complete.\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nPer-instance SHAP calculations complete.\n```\n\n\n:::\n:::\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}